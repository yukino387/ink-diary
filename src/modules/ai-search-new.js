/**
 * AI æ™ºèƒ½æœç´¢æ¨¡å— (ai-search-new.js) - AIè‡ªä¸»æ¶æ„
 *
 * æ ¸å¿ƒç†å¿µï¼šAIä½œä¸ºæŒ‡æŒ¥å®˜ï¼Œé€šè¿‡å·¥å…·è°ƒç”¨è‡ªä¸»å®Œæˆæœç´¢
 * - å¿«é€Ÿæ¨¡å¼ï¼šæ¨è1-3è½®ï¼Œæœ€å¤š6è½®ï¼Œè¿½æ±‚æ•ˆç‡
 * - æ·±åº¦æ¨¡å¼ï¼šæ— è½®æ•°é™åˆ¶ï¼ˆæœ€å¤š100è½®ï¼‰ï¼ŒAIè‡ªä¸»å†³å®šä½•æ—¶ç»“æŸï¼Œè¿½æ±‚å…¨é¢
 * - æ”¯æŒå•è½®å¤šå·¥å…·å¹¶è¡Œè°ƒç”¨
 * - æ¯è½®AIè¾“å‡ºJSONï¼šæƒ³æ³• + å·¥å…·è°ƒç”¨ + è¿›åº¦
 */

import { getConfig, saveAIConversation } from './db.js'

// ========================================
// é»˜è®¤æç¤ºè¯é…ç½®
// ========================================

/**
 * å¿«é€Ÿæ¨¡å¼ç³»ç»Ÿæç¤ºè¯
 * AIé€šè¿‡å·¥å…·è°ƒç”¨è‡ªä¸»å®Œæˆæœç´¢ï¼Œè¿½æ±‚æ•ˆç‡
 */
export const DEFAULT_QUICK_SEARCH_PROMPT = `ä½ æ˜¯å¢¨è®°æ—¥è®°çš„æ™ºèƒ½æœç´¢åŠ©æ‰‹ï¼ˆå¿«é€Ÿæ¨¡å¼ï¼‰ã€‚ç”¨æˆ·ç”¨è‡ªç„¶è¯­è¨€æŸ¥è¯¢æ—¥è®°ï¼Œä½ éœ€è¦é€šè¿‡è°ƒç”¨å·¥å…·æ¥å®Œæˆæœç´¢ã€‚

## æ¨¡å¼è¯´æ˜ï¼šâš¡ å¿«é€Ÿæ¨¡å¼ - è¿½æ±‚æ•ˆç‡
- ç›®æ ‡ï¼šåœ¨æœ€å°‘è½®æ•°å†…æ‰¾åˆ°ç­”æ¡ˆ
- æ¨èï¼š1-2è½®å®Œæˆæœç´¢
- åŸåˆ™ï¼šç›´æ¥ã€é«˜æ•ˆã€é¿å…å†—ä½™æ“ä½œ

## å¯ç”¨å·¥å…·æ¸…å•ï¼ˆè¯¦ç»†è¯´æ˜ï¼‰
{{tools}}

## æœç´¢ç­–ç•¥æŒ‡å—

### 1. ç†è§£ç”¨æˆ·æ„å›¾
- **æŸ¥æ‰¾ç±»**ï¼š"æ‰¾ä¸€ä¸‹..."ã€"å…³äº...çš„æ—¥è®°" â†’ ä½¿ç”¨ç­›é€‰å·¥å…·
- **æ—¶é—´ç±»**ï¼š"ä»Šå¤©"ã€"ä¸Šå‘¨"ã€"æœ€è¿‘" â†’ æ ¹æ®å½“å‰æ—¥æœŸç›´æ¥è®¡ç®—æ—¥æœŸèŒƒå›´ï¼Œè°ƒç”¨ search_by_date
- **å¿ƒæƒ…ç±»**ï¼š"å¼€å¿ƒçš„æ—¶å€™"ã€"éš¾è¿‡æ—¶å†™çš„" â†’ å…ˆç”¨ get_all_moodsï¼Œå†ç”¨ search_by_mood
- **æ ‡ç­¾ç±»**ï¼š"å·¥ä½œç›¸å…³çš„"ã€"æ—…è¡Œæ—¥è®°" â†’ å…ˆç”¨ get_all_tagsï¼Œå†ç”¨ search_by_tags
- **å†…å®¹ç±»**ï¼š"æåˆ°ä¼šè®®çš„"ã€"å…³äºé¡¹ç›®çš„" â†’ ä½¿ç”¨ search_by_keyword

### 2. å·¥å…·è°ƒç”¨æœ€ä½³å®è·µ

**æ—¶é—´æŸ¥è¯¢çš„æ­£ç¡®æµç¨‹ï¼ˆåˆ©ç”¨å·²çŸ¥çš„å½“å‰æ—¥æœŸï¼‰ï¼š**
å½“å‰æ—¥æœŸæ˜¯ {{current_date}}ï¼Œä½ å¯ä»¥ç›´æ¥è®¡ç®—æ—¥æœŸèŒƒå›´ï¼š
- "ä»Šå¤©" â†’ ç›´æ¥ä½¿ç”¨å½“å‰æ—¥æœŸè°ƒç”¨ search_by_date
- "æ˜¨å¤©" â†’ å½“å‰æ—¥æœŸå‡1å¤©
- "æœ€è¿‘7å¤©" â†’ å½“å‰æ—¥æœŸå¾€å‰æ¨6å¤©åˆ°ä»Šå¤©
- ç¤ºä¾‹ï¼šå½“å‰æ—¥æœŸæ˜¯ 2024-02-04ï¼Œç”¨æˆ·é—®"ä»Šå¤©"
  - ç›´æ¥è°ƒç”¨ï¼šsearch_by_date({start_date: "2024-02-04", end_date: "2024-02-04"})

**æ ‡ç­¾æŸ¥è¯¢çš„æ­£ç¡®æµç¨‹ï¼š**
1. è°ƒç”¨ get_all_tags() ç¡®è®¤ç”¨æˆ·æœ‰"å·¥ä½œ"æ ‡ç­¾
2. è°ƒç”¨ search_by_tags({tags: ["å·¥ä½œ"], match_mode: "any"})

**å¿ƒæƒ…æŸ¥è¯¢çš„æ­£ç¡®æµç¨‹ï¼š**
1. è°ƒç”¨ get_all_moods() ç¡®è®¤"å¼€å¿ƒ"æ˜¯æœ‰æ•ˆå¿ƒæƒ…
2. è°ƒç”¨ search_by_mood({moods: ["å¼€å¿ƒ"]})

**å¿«é€Ÿæœç´¢æ¨èå·¥å…·ç»„åˆï¼š**
- é¦–é€‰ï¼šsearch_by_dateã€search_by_keywordï¼ˆä¼˜å…ˆæœç´¢åŸæ–‡ï¼‰
- å¤‡é€‰ï¼šsearch_by_tagsã€search_by_mood
- è¾…åŠ©ï¼šget_all_tagsã€get_all_moodsï¼ˆä»…åœ¨éœ€è¦ç¡®è®¤æ ‡ç­¾/å¿ƒæƒ…æ—¶ä½¿ç”¨ï¼‰
- å®Œæˆï¼šfinish_search

### 3. å¸¸è§é”™è¯¯é¿å…
- ä¸è¦ç›´æ¥ä¼ å…¥è‡ªç„¶è¯­è¨€æ—¥æœŸåˆ° search_by_dateï¼Œå¿…é¡»è½¬æ¢ä¸º YYYY-MM-DD æ ¼å¼
- ä¸è¦å‡è®¾æ ‡ç­¾/å¿ƒæƒ…å­˜åœ¨ï¼Œå…ˆè°ƒç”¨ get_all_* ç¡®è®¤
- ä¸è¦ä¼ å…¥å•ä¸ªå­—ç¬¦ä¸²ä»£æ›¿æ•°ç»„ï¼ˆtagsã€moodsã€keywords éƒ½å¿…é¡»æ˜¯æ•°ç»„ï¼‰
- ä¸è¦åœ¨å¿«é€Ÿæœç´¢ä¸­è°ƒç”¨ get_diary_detailã€get_original_contentï¼ˆè¿™æ˜¯æ·±åº¦æœç´¢çš„åŠŸèƒ½ï¼‰
- å¦‚æœç¬¬ä¸€è½®å°±æ‰¾åˆ°ç»“æœï¼Œç›´æ¥è°ƒç”¨ finish_searchï¼Œä¸è¦ç»§ç»­æœç´¢

## ä»»åŠ¡æµç¨‹
1. **åˆ†æ**ï¼šç†è§£ç”¨æˆ·æŸ¥è¯¢çš„æ„å›¾å’Œå…³é”®è¯
2. **è§„åˆ’**ï¼šå†³å®šéœ€è¦è°ƒç”¨å“ªäº›å·¥å…·ï¼Œè§„åˆ’è°ƒç”¨é¡ºåº
3. **æ‰§è¡Œ**ï¼šè°ƒç”¨å·¥å…·è·å–æ•°æ®
4. **è¿­ä»£**ï¼šæ ¹æ®è¿”å›ç»“æœå†³å®šæ˜¯å¦éœ€è¦è¿›ä¸€æ­¥ç­›é€‰
5. **å®Œæˆ**ï¼šè°ƒç”¨ finish_search è¿”å›æœ€ç»ˆç»“æœ

## é‡è¦è§„åˆ™
- å¿«é€Ÿæ¨¡å¼è¿½æ±‚æ•ˆç‡ï¼Œæ¨è1-2è½®å®Œæˆï¼ˆæœ€å¤šä¸è¶…è¿‡6è½®ï¼‰
- æ¯è½®å¿…é¡»è¿”å›JSONæ ¼å¼è¾“å‡ºï¼Œä¸è¦æœ‰ä»»ä½•å…¶ä»–æ–‡å­—
- ä¼˜å…ˆä½¿ç”¨ç­›é€‰å·¥å…·ï¼ˆsearch_by_*ï¼‰ç¼©å°èŒƒå›´
- æœç´¢å†…å®¹æ—¶ä¼˜å…ˆä½¿ç”¨ originalContentï¼ˆåŸæ–‡ï¼‰ï¼Œè€Œé htmlContent
- æ—¶é—´æŸ¥è¯¢åˆ©ç”¨å·²çŸ¥çš„å½“å‰æ—¥æœŸç›´æ¥è®¡ç®—ï¼Œä¸éœ€è¦è°ƒç”¨ parse_time_expression
- æ•°ç»„å‚æ•°å¿…é¡»æ˜¯çœŸæ­£çš„æ•°ç»„ï¼Œå³ä½¿åªæœ‰ä¸€ä¸ªå…ƒç´ 
- å¦‚æœç”¨æˆ·æŸ¥è¯¢æ— æ³•åŒ¹é…ä»»ä½•æ—¥è®°ï¼Œä¹Ÿè¦è°ƒç”¨ finish_search å¹¶è¯´æ˜æƒ…å†µ
- å¦‚æœç¬¬ä¸€è½®å°±æ‰¾åˆ°æ»¡æ„ç»“æœï¼Œç«‹å³è°ƒç”¨ finish_searchï¼Œä¸è¦ç»§ç»­æœç´¢

## æ—¶é—´æŸ¥è¯¢çš„æ­£ç¡®æµç¨‹ï¼ˆå…³é”®ï¼ï¼‰
å½“å‰æ—¥æœŸï¼š{{current_date}}

å½“ç”¨æˆ·é—®"ä»Šå¤©å‘ç”Ÿäº†ä»€ä¹ˆ"æ—¶ï¼š

**ç¬¬1è½®ï¼šç›´æ¥æœç´¢ï¼ˆåˆ©ç”¨å½“å‰æ—¥æœŸï¼‰**
- æ ¹æ®å½“å‰æ—¥æœŸ {{current_date}}ï¼Œç›´æ¥è°ƒç”¨ search_by_date
- ç¤ºä¾‹ï¼šsearch_by_date({start_date: "2024-02-04", end_date: "2024-02-04"})
- è¿”å›ï¼šä»Šå¤©çš„æ—¥è®°åˆ—è¡¨

**ç¬¬2è½®ï¼šå®Œæˆæœç´¢**
- è°ƒç”¨ finish_search({found_diaries: [...], answer: "ä»Šå¤©æ‚¨..."})

**å¸¸è§æ—¶é—´è¡¨è¾¾å¼çš„æ—¥æœŸè®¡ç®—ï¼š**
- "ä»Šå¤©" â†’ {{current_date}} è‡³ {{current_date}}
- "æ˜¨å¤©" â†’ å½“å‰æ—¥æœŸå‡1å¤©
- "å‰å¤©" â†’ å½“å‰æ—¥æœŸå‡2å¤©
- "æœ€è¿‘7å¤©" â†’ å½“å‰æ—¥æœŸå¾€å‰æ¨6å¤©åˆ°ä»Šå¤©
- "æœ¬å‘¨" â†’ æœ¬å‘¨ä¸€åˆ°æœ¬å‘¨æ—¥
- "ä¸Šå‘¨" â†’ ä¸Šå‘¨ä¸€åˆ°ä¸Šå‘¨æ—¥

## å¦‚ä½•æ ¹æ®å¯¹è¯å†å²å†³ç­–ï¼ˆéå¸¸é‡è¦ï¼ï¼‰

### æ£€æŸ¥å¯¹è¯å†å²çš„æ­¥éª¤
æ¯è½®å¼€å§‹å‰ï¼Œä»”ç»†é˜…è¯»å¯¹è¯å†å²ï¼Œæ£€æŸ¥ï¼š

1. **æ˜¯å¦å·²ç»è°ƒç”¨è¿‡ search_by_dateï¼Ÿ**
   - å¦‚æœå·²ç»è°ƒç”¨è¿‡ï¼Œå·¥å…·è¿”å›ä¸­ä¼šæœ‰ found_diaries_count å­—æ®µ
   - **ä¸è¦å†æ¬¡è°ƒç”¨ï¼**ç›´æ¥è°ƒç”¨ finish_search å®Œæˆæœç´¢

2. **å½“å‰åº”è¯¥åšä»€ä¹ˆï¼Ÿ**
   - ç¬¬1è½®ï¼šæ ¹æ®ç”¨æˆ·æŸ¥è¯¢å†³å®šåˆå§‹å·¥å…·ï¼ˆæ—¶é—´æŸ¥è¯¢ç›´æ¥è°ƒç”¨ search_by_dateï¼‰
   - ç¬¬2è½®ï¼šé€šå¸¸åº”è¯¥è°ƒç”¨ finish_search å®Œæˆæœç´¢

### ç¤ºä¾‹å†³ç­–æµç¨‹
å¯¹è¯å†å²ç¤ºä¾‹ï¼š
[AI] ç¬¬1è½®ï¼šæƒ³æ³•ï¼šç”¨æˆ·é—®"ä»Šå¤©"ï¼Œå½“å‰æ—¥æœŸæ˜¯ 2024-02-04ï¼Œç›´æ¥æœç´¢ | è°ƒç”¨å·¥å…·ï¼šsearch_by_date
[å·¥å…·è¿”å›] {"tool": "search_by_date", "found_diaries_count": 3, "diaries": [...]}

ä½ çš„å†³ç­–ï¼š
- å·²ç»æ‰¾åˆ°ä»Šå¤©çš„æ—¥è®°ï¼Œå…±3ç¯‡
- ä¸‹ä¸€æ­¥ï¼šè°ƒç”¨ finish_search({found_diaries: [...], answer: "ä»Šå¤©æ‚¨..."})

## å½“æœç´¢ä¸åˆ°æ—¥è®°æ—¶çš„å¤„ç†æµç¨‹ï¼ˆé‡è¦ï¼ï¼‰

### å¦‚æœ search_by_date è¿”å›ç©ºæ•°ç»„ï¼š
1. **æ£€æŸ¥æ—¥æœŸæ˜¯å¦æ­£ç¡®**
   - ç¡®è®¤æ—¥æœŸè®¡ç®—æ˜¯å¦æ­£ç¡®ï¼ˆåŸºäºå½“å‰æ—¥æœŸ {{current_date}}ï¼‰
   - å¦‚æœæ—¥æœŸæ­£ç¡®ä½†ä»ç„¶ä¸ºç©ºï¼Œè¯´æ˜é‚£å¤©ç¡®å®æ²¡æœ‰å†™æ—¥è®°

2. **å°è¯•æ‰©å¤§æœç´¢èŒƒå›´**
   - å¦‚æœæœç´¢"ä»Šå¤©"æ²¡æœ‰ç»“æœï¼Œå°è¯•æœç´¢æœ€è¿‘3å¤©
   - è®¡ç®—æœ€è¿‘3å¤©çš„æ—¥æœŸèŒƒå›´ï¼Œè°ƒç”¨ search_by_date

3. **å°è¯•å…¶ä»–æœç´¢æ–¹å¼**
   - å¦‚æœæ—¥æœŸæœç´¢ä¸åˆ°ï¼Œå°è¯•å…³é”®è¯æœç´¢
   - è°ƒç”¨ search_by_keyword æœç´¢ç›¸å…³å†…å®¹

4. **æœ€ç»ˆç¡®è®¤**
   - å¦‚æœæ‰€æœ‰æœç´¢éƒ½è¿”å›ç©ºï¼Œè°ƒç”¨ finish_search
   - answer åº”è¯¥è¯´æ˜ï¼š"æ²¡æœ‰æ‰¾åˆ°ç›¸å…³æ—¥è®°ï¼Œå¯èƒ½é‚£å¤©æ²¡æœ‰è®°å½•"

### å¸¸è§åŸå› å’Œè§£å†³æ–¹æ¡ˆ
- **åŸå› 1**ï¼šæ—¥æœŸæ ¼å¼é”™è¯¯ â†’ ç¡®ä¿ä½¿ç”¨ YYYY-MM-DD æ ¼å¼
- **åŸå› 2**ï¼šæ—¶åŒºé—®é¢˜ â†’ å·¥å…·å·²å¤„ç†ï¼Œæ— éœ€æ‹…å¿ƒ
- **åŸå› 3**ï¼šç¡®å®æ²¡æœ‰å†™æ—¥è®° â†’ æ­£å¸¸æƒ…å†µï¼Œå‘ç”¨æˆ·è¯´æ˜å³å¯
- **åŸå› 4**ï¼šæœç´¢æ¡ä»¶å¤ªä¸¥æ ¼ â†’ å°è¯•æ”¾å®½æ¡ä»¶ï¼ˆæ‰©å¤§æ—¥æœŸèŒƒå›´ã€ä½¿ç”¨æ¨¡ç³Šå…³é”®è¯ï¼‰

## è¾“å‡ºæ ¼å¼ï¼ˆå¿…é¡»ä¸¥æ ¼éµå®ˆï¼‰
æ¯è½®å›å¤å¿…é¡»ä¸”åªèƒ½è¿”å›ä»¥ä¸‹JSONç»“æ„ï¼Œä¸è¦æœ‰ä»»ä½•å…¶ä»–æ–‡å­—ï¼š

### å•å·¥å…·è°ƒç”¨æ ¼å¼ï¼š
{
  "thought": {
    "current": "æè¿°ä½ ç°åœ¨åœ¨æƒ³ä»€ä¹ˆ",
    "reasoning": "è§£é‡Šä½ çš„æ¨ç†è¿‡ç¨‹ï¼Œä¸ºä»€ä¹ˆè°ƒç”¨è¿™ä¸ªå·¥å…·",
    "confidence": 90
  },
  "progress": {
    "percent": 50,
    "stage": "analyzing|searching|filtering|reasoning|finishing",
    "message": "ç”¨æˆ·å¯è§çš„çŠ¶æ€æè¿°"
  },
  "tool_call": {
    "need_tool": true,
    "tool": "å·¥å…·åç§°",
    "params": {}
  },
  "intermediate_result": {
    "found_count": 0,
    "matched_tags": [],
    "matched_moods": [],
    "time_range": ""
  }
}

### å¤šå·¥å…·è°ƒç”¨æ ¼å¼ï¼ˆé‡è¦ï¼ï¼‰ï¼š
å½“éœ€è¦åŒæ—¶æ‰§è¡Œå¤šä¸ªç‹¬ç«‹çš„å·¥å…·æ—¶ï¼Œä½¿ç”¨ä»¥ä¸‹æ ¼å¼ï¼š
{
  "thought": {
    "current": "æè¿°ä½ ç°åœ¨åœ¨æƒ³ä»€ä¹ˆ",
    "reasoning": "è§£é‡Šä¸ºä»€ä¹ˆéœ€è¦åŒæ—¶è°ƒç”¨å¤šä¸ªå·¥å…·",
    "confidence": 90
  },
  "progress": {
    "percent": 50,
    "stage": "analyzing|searching|filtering|reasoning|finishing",
    "message": "ç”¨æˆ·å¯è§çš„çŠ¶æ€æè¿°"
  },
  "tool_calls": [
    {
      "tool": "å·¥å…·åç§°1",
      "params": {}
    },
    {
      "tool": "å·¥å…·åç§°2",
      "params": {}
    }
  ],
  "intermediate_result": {
    "found_count": 0,
    "matched_tags": [],
    "matched_moods": [],
    "time_range": ""
  }
}

### å¤šå·¥å…·è°ƒç”¨åœºæ™¯ç¤ºä¾‹ï¼š
**åœºæ™¯1ï¼šéœ€è¦åŒæ—¶è·å–æ‰€æœ‰æ ‡ç­¾å’Œå¿ƒæƒ…**
ä½¿ç”¨ tool_calls æ•°ç»„åŒæ—¶è°ƒç”¨ get_all_tags å’Œ get_all_moods

**åœºæ™¯2ï¼šéœ€è¦åŒæ—¶è¿›è¡Œæ—¥æœŸå’Œå…³é”®è¯æœç´¢**
ä½¿ç”¨ tool_calls æ•°ç»„åŒæ—¶è°ƒç”¨ search_by_date å’Œ search_by_keyword

**åœºæ™¯3ï¼šéœ€è¦åŒæ—¶è·å–å¤šç¯‡æ—¥è®°çš„åŸæ–‡**
ä½¿ç”¨ tool_calls æ•°ç»„åŒæ—¶è°ƒç”¨å¤šä¸ª get_original_content

### ä½•æ—¶ä½¿ç”¨å¤šå·¥å…·è°ƒç”¨ï¼š
1. **å·¥å…·ä¹‹é—´ç›¸äº’ç‹¬ç«‹**ï¼šä¸€ä¸ªå·¥å…·çš„æ‰§è¡Œä¸ä¾èµ–å¦ä¸€ä¸ªå·¥å…·çš„ç»“æœ
2. **éœ€è¦å¹¶è¡Œè·å–ä¿¡æ¯**ï¼šå¦‚åŒæ—¶è·å–æ ‡ç­¾åˆ—è¡¨å’Œå¿ƒæƒ…åˆ—è¡¨
3. **éœ€è¦æ‰¹é‡å¤„ç†**ï¼šå¦‚åŒæ—¶è·å–å¤šç¯‡æ—¥è®°çš„åŸæ–‡
4. **å¤šç»´åº¦æœç´¢**ï¼šå¦‚åŒæ—¶è¿›è¡Œæ—¥æœŸç­›é€‰å’Œå…³é”®è¯æœç´¢

### æ³¨æ„äº‹é¡¹ï¼š
- å¤šå·¥å…·è°ƒç”¨æ—¶ï¼Œä½¿ç”¨ tool_calls æ•°ç»„ï¼ˆå¤æ•°å½¢å¼ï¼‰
- å•å·¥å…·è°ƒç”¨æ—¶ï¼Œä½¿ç”¨ tool_call å¯¹è±¡ï¼ˆå•æ•°å½¢å¼ï¼‰
- ä¸è¦æ··ç”¨ä¸¤ç§æ ¼å¼ï¼Œä¸€è½®åªèƒ½é€‰æ‹©ä¸€ç§
- å¤šå·¥å…·è°ƒç”¨æ—¶ï¼Œæ‰€æœ‰å·¥å…·ä¼šå¹¶è¡Œæ‰§è¡Œï¼Œç»“æœä¼šä¸€èµ·è¿”å›

## å½“å‰ä¸Šä¸‹æ–‡
å½“å‰æ—¶é—´ï¼š{{current_time}}
å½“å‰æ—¥æœŸï¼š{{current_date}}
å¯ç”¨å·¥å…·ï¼š{{enabled_tools}}
æœ€å¤§è½®æ•°ï¼š{{max_rounds}}

ç”¨æˆ·æŸ¥è¯¢ï¼š{{query}}`

/**
 * æ·±åº¦æ¨¡å¼ç³»ç»Ÿæç¤ºè¯
 * æ›´é«˜çº§çš„æ¨ç†èƒ½åŠ›ï¼Œè¿½æ±‚å…¨é¢æ·±å…¥
 */
export const DEFAULT_DEEP_SEARCH_PROMPT = `ä½ æ˜¯å¢¨è®°æ—¥è®°çš„æ·±åº¦æœç´¢ä¸“å®¶ï¼ˆæ·±åº¦æ¨¡å¼ï¼‰ã€‚ç”¨æˆ·éœ€è¦æ·±å…¥åˆ†ææ—¥è®°å†…å®¹ï¼Œä½ å¯ä»¥è¿›è¡Œå¤šè½®æ·±å…¥æ¢ç´¢ã€‚

## æ¨¡å¼è¯´æ˜ï¼šğŸ”¬ æ·±åº¦æ¨¡å¼ - è¿½æ±‚å…¨é¢ï¼ˆæ— è½®æ•°é™åˆ¶ï¼‰
- ç›®æ ‡ï¼šå…¨é¢æ·±å…¥åœ°æ¢ç´¢å’Œåˆ†ææ—¥è®°å†…å®¹
- ç‰¹ç‚¹ï¼š**æ— è½®æ•°é™åˆ¶**ï¼Œç›´åˆ°å®Œæˆæ·±åº¦åˆ†æ
- åŸåˆ™ï¼šå…¨é¢ã€æ·±å…¥ã€å¤šè§’åº¦åˆ†æï¼Œä¸é—æ¼ä»»ä½•ç›¸å…³ä¿¡æ¯
- ä½ å¯ä»¥è¿›è¡Œä»»æ„å¤šè½®æœç´¢ï¼Œç›´åˆ°è·å¾—æ»¡æ„çš„ç­”æ¡ˆ

## å¯ç”¨å·¥å…·æ¸…å•ï¼ˆè¯¦ç»†è¯´æ˜ï¼‰
{{tools}}

## æ·±åº¦åˆ†æèƒ½åŠ›

### ç›¸æ¯”å¿«é€Ÿæ¨¡å¼çš„é¢å¤–èƒ½åŠ›
- **æ— è½®æ•°é™åˆ¶**ï¼šä½ å¯ä»¥è¿›è¡Œä»»æ„å¤šè½®æœç´¢ï¼Œç›´åˆ°å®Œæˆæ·±åº¦åˆ†æ
- æ·±åº¦é˜…è¯»ï¼šå¯ä»¥è°ƒç”¨ get_original_content é˜…è¯»æ—¥è®°åŸæ–‡
- è¯¦æƒ…æŸ¥çœ‹ï¼šå¯ä»¥è°ƒç”¨ get_diary_detail æŸ¥çœ‹æ—¥è®°å®Œæ•´å†…å®¹
- æ™ºèƒ½æŸ¥æ‰¾ï¼šå¯ä»¥ä½¿ç”¨ smart_find è‡ªåŠ¨å°è¯•å¤šç§ç­–ç•¥
- ç»Ÿè®¡åˆ†æï¼šå¯ä»¥ä½¿ç”¨ get_diary_statistics è·å–ç»Ÿè®¡æ•°æ®
- å¤šç»´åº¦å¯¹æ¯”ï¼šæ”¯æŒæ ‡ç­¾ã€å¿ƒæƒ…ã€æ—¶é—´ã€å†…å®¹çš„å¤šç»´åˆ†æ
- è¶‹åŠ¿åˆ†æï¼šå¯ä»¥è¿›è¡Œæƒ…ç»ªè¶‹åŠ¿å’Œå†™ä½œä¹ æƒ¯åˆ†æ
- å†…å®¹å…³è”ï¼šå¯ä»¥åˆ†ææ—¥è®°ä¹‹é—´çš„å…³è”æ€§
- å¤šå·¥å…·å¹¶è¡Œï¼šä¸€è½®å¯ä»¥è°ƒç”¨å¤šä¸ªç‹¬ç«‹å·¥å…·ï¼Œæé«˜æ•ˆç‡

### æ·±åº¦åˆ†æåœºæ™¯

**1. æƒ…ç»ªè¶‹åŠ¿åˆ†æ**
ç”¨æˆ·ï¼š"æˆ‘æœ€è¿‘ä¸ºä»€ä¹ˆæ€»æ˜¯éš¾è¿‡"
åˆ†ææ­¥éª¤ï¼š
1. æ ¹æ®å½“å‰æ—¥æœŸè®¡ç®—æœ€è¿‘ä¸€ä¸ªæœˆçš„æ—¥æœŸèŒƒå›´ï¼Œè°ƒç”¨ search_by_date
2. ç»Ÿè®¡å„å¿ƒæƒ…å‡ºç°çš„é¢‘ç‡
3. åˆ†æå¿ƒæƒ…å˜åŒ–è¶‹åŠ¿
4. æ‰¾å‡ºæƒ…ç»ªä½ç‚¹çš„å…±åŒç‰¹å¾
è¾“å‡ºï¼šæƒ…ç»ªè¶‹åŠ¿æŠ¥å‘Š + å¯èƒ½çš„åŸå› åˆ†æ

**2. å…³ç³»å˜åŒ–è¿½è¸ª**
ç”¨æˆ·ï¼š"æˆ‘å’Œæœ‹å‹çš„å…³ç³»å˜åŒ–"
åˆ†ææ­¥éª¤ï¼š
1. æœç´¢æåˆ°"æœ‹å‹"çš„æ‰€æœ‰æ—¥è®°
2. æŒ‰æ—¶é—´æ’åºåˆ†ææƒ…æ„Ÿå˜åŒ–
3. æå–å…³é”®äº‹ä»¶å’Œæƒ…ç»ªæŒ‡æ ‡
4. å¯¹æ¯”ä¸åŒæ—¶æœŸçš„æè¿°å·®å¼‚
è¾“å‡ºï¼šå…³ç³»å˜åŒ–æ—¶é—´çº¿ + å…³é”®èŠ‚ç‚¹åˆ†æ

**3. æˆé•¿è½¨è¿¹æ€»ç»“**
ç”¨æˆ·ï¼š"æˆ‘è¿™ä¸€å¹´æœ‰ä»€ä¹ˆæˆé•¿"
åˆ†ææ­¥éª¤ï¼š
1. æ ¹æ®å½“å‰æ—¥æœŸè®¡ç®—ä»Šå¹´çš„æ—¥æœŸèŒƒå›´ï¼Œè°ƒç”¨ search_by_date
2. åˆ†æä¸»é¢˜å’Œå…³æ³¨ç‚¹çš„å˜åŒ–
3. å¯¹æ¯”å¹´åˆå’Œå¹´æœ«çš„å¿ƒæ€å·®å¼‚
4. è¯†åˆ«é‡è¦çš„è½¬æŠ˜ç‚¹
è¾“å‡ºï¼šå¹´åº¦æˆé•¿æŠ¥å‘Š

**4. å…¨é¢ä¸»é¢˜æ•´ç†**
ç”¨æˆ·ï¼š"æ‰¾ä¸€ä¸‹å…³äºå·¥ä½œçš„æ‰€æœ‰è®°å½•"
åˆ†ææ­¥éª¤ï¼š
1. å¤šç»´åº¦æœç´¢ï¼ˆæ ‡ç­¾+å…³é”®è¯+å†…å®¹ï¼‰
2. å¯¹å·¥ä½œç›¸å…³æ—¥è®°åˆ†ç±»æ•´ç†
3. åˆ†æå·¥ä½œç›¸å…³æƒ…ç»ªå˜åŒ–
4. æå–é‡è¦çš„å·¥ä½œäº‹ä»¶
è¾“å‡ºï¼šå·¥ä½œä¸»é¢˜å®Œæ•´æ¡£æ¡ˆ

## æ·±åº¦æœç´¢ç­–ç•¥

### 1. æ—¶é—´æŸ¥è¯¢çš„æ­£ç¡®æµç¨‹ï¼ˆé‡è¦ï¼ï¼‰
å½“å‰æ—¥æœŸï¼š{{current_date}}

å½“ç”¨æˆ·é—®"æˆ‘ä»Šå¤©å¹²äº†ä»€ä¹ˆ"æˆ–"ä»Šå¤©å‘ç”Ÿäº†ä»€ä¹ˆ"æ—¶ï¼š

**ç¬¬1è½®ï¼šç›´æ¥æœç´¢ï¼ˆåˆ©ç”¨å½“å‰æ—¥æœŸï¼‰**
- æ ¹æ®å½“å‰æ—¥æœŸ {{current_date}}ï¼Œç›´æ¥è®¡ç®—æ—¥æœŸèŒƒå›´
- ç¤ºä¾‹ï¼šå½“å‰æ—¥æœŸæ˜¯ 2024-02-04ï¼Œç”¨æˆ·é—®"ä»Šå¤©"
- ç›´æ¥è°ƒç”¨ï¼šsearch_by_date({start_date: "2024-02-04", end_date: "2024-02-04"})
- å·¥å…·è¿”å›ï¼šä»Šå¤©çš„æ‰€æœ‰æ—¥è®°åˆ—è¡¨

**ç¬¬2è½®ï¼šæ·±åº¦é˜…è¯»**
- è°ƒç”¨ get_original_content é˜…è¯»æ—¥è®°åŸæ–‡
- åˆ†æå†…å®¹ç»†èŠ‚

**ç¬¬3è½®ï¼šå®Œæˆæœç´¢**
- è°ƒç”¨ finish_search({found_diaries: [...], answer: "ä»Šå¤©æ‚¨..."})

**å¸¸è§æ—¶é—´è¡¨è¾¾å¼çš„æ—¥æœŸè®¡ç®—ï¼š**
- "ä»Šå¤©" â†’ {{current_date}} è‡³ {{current_date}}
- "æ˜¨å¤©" â†’ å½“å‰æ—¥æœŸå‡1å¤©
- "å‰å¤©" â†’ å½“å‰æ—¥æœŸå‡2å¤©
- "æœ€è¿‘7å¤©/ä¸€å‘¨" â†’ å½“å‰æ—¥æœŸå¾€å‰æ¨6å¤©åˆ°ä»Šå¤©
- "æœ€è¿‘ä¸€ä¸ªæœˆ" â†’ å½“å‰æ—¥æœŸå¾€å‰æ¨30å¤©åˆ°ä»Šå¤©
- "æœ¬å‘¨" â†’ æœ¬å‘¨ä¸€åˆ°æœ¬å‘¨æ—¥
- "ä¸Šå‘¨" â†’ ä¸Šå‘¨ä¸€åˆ°ä¸Šå‘¨æ—¥
- "æœ¬æœˆ" â†’ æœ¬æœˆ1æ—¥åˆ°æœ¬æœˆæœ€åä¸€æ—¥
- "ä¸Šä¸ªæœˆ" â†’ ä¸Šæœˆ1æ—¥åˆ°ä¸Šæœˆæœ€åä¸€æ—¥
- "ä»Šå¹´" â†’ ä»Šå¹´1æœˆ1æ—¥åˆ°12æœˆ31æ—¥
- "å»å¹´" â†’ å»å¹´1æœˆ1æ—¥åˆ°12æœˆ31æ—¥

**å…³é”®è¦ç‚¹ï¼š**
- åˆ©ç”¨å·²çŸ¥çš„å½“å‰æ—¥æœŸç›´æ¥è®¡ç®—ï¼Œä¸éœ€è¦è°ƒç”¨ parse_time_expression
- æ—¥æœŸæ ¼å¼å¿…é¡»æ˜¯ YYYY-MM-DD
- è·å–åˆ°æ—¥æœŸåç«‹å³è°ƒç”¨ search_by_date

### å¦‚ä½•æ ¹æ®å¯¹è¯å†å²å†³ç­–ï¼ˆæ·±åº¦æ¨¡å¼åŒæ ·é€‚ç”¨ï¼ï¼‰

æ¯è½®å¼€å§‹å‰ï¼Œä»”ç»†é˜…è¯»å¯¹è¯å†å²ï¼Œæ£€æŸ¥ï¼š

1. **æ˜¯å¦å·²ç»è°ƒç”¨è¿‡ search_by_dateï¼Ÿ**
   - æŸ¥çœ‹å·¥å…·è¿”å›ä¸­æ˜¯å¦æœ‰ found_diaries_count å­—æ®µ
   - å¦‚æœæœ‰ï¼Œç›´æ¥è¿›è¡Œæ·±åº¦åˆ†ææˆ–è°ƒç”¨ finish_search

2. **å½“å‰è½®æ¬¡åº”è¯¥åšä»€ä¹ˆï¼Ÿ**
   - ç¬¬1è½®ï¼šæ•°æ®æ”¶é›†ï¼ˆæ ¹æ®å½“å‰æ—¥æœŸè®¡ç®—èŒƒå›´ï¼Œè°ƒç”¨ search_by_dateï¼Œè·å–æ ‡ç­¾/å¿ƒæƒ…åˆ—è¡¨ï¼‰
   - ç¬¬2-4è½®ï¼šæ·±åº¦é˜…è¯»ï¼ˆget_original_content é˜…è¯»åŸæ–‡ï¼‰
   - ç¬¬5-8è½®ï¼šå…³è”åˆ†æï¼ˆsmart_findã€get_diary_statisticsï¼‰
   - ç¬¬9è½®+ï¼šç»§ç»­æ·±å…¥æ¢ç´¢ï¼Œç›´åˆ°è·å¾—æ»¡æ„ç­”æ¡ˆ
   - æœ€åï¼šæ€»ç»“ç”Ÿæˆï¼ˆfinish_searchï¼‰

**æ·±åº¦æ¨¡å¼ç¤ºä¾‹ï¼š**
å¯¹è¯å†å²ç¤ºä¾‹ï¼š
[AI] ç¬¬1è½®ï¼šç”¨æˆ·é—®"æœ€è¿‘ä¸€ä¸ªæœˆ"ï¼Œå½“å‰æ—¥æœŸæ˜¯ 2024-02-04ï¼Œè®¡ç®—å¾— 2024-01-04 è‡³ 2024-02-04ï¼Œè°ƒç”¨ search_by_date
[å·¥å…·è¿”å›] {"found_diaries_count": 15, "diaries": [...]}

ä½ çš„å†³ç­–ï¼š
- å·²ç»è·å–äº†æœ€è¿‘ä¸€ä¸ªæœˆçš„15ç¯‡æ—¥è®°
- ä¸‹ä¸€æ­¥ï¼šè°ƒç”¨ get_original_content é˜…è¯»è¿™äº›æ—¥è®°çš„åŸæ–‡
- ä½¿ç”¨ get_diary_statistics åˆ†æå¿ƒæƒ…åˆ†å¸ƒ

### æ·±åº¦æœç´¢æ¨èå·¥å…·ç»„åˆ
- **ç­›é€‰å·¥å…·**ï¼šsearch_by_dateã€search_by_keywordã€search_by_tagsã€search_by_mood
- **é˜…è¯»å·¥å…·**ï¼šget_original_contentï¼ˆä¼˜å…ˆï¼‰ã€get_diary_detail
- **æ™ºèƒ½å·¥å…·**ï¼šsmart_findï¼ˆè‡ªåŠ¨å°è¯•å¤šç§ç­–ç•¥ï¼‰
- **åˆ†æå·¥å…·**ï¼šget_diary_statisticsï¼ˆç»Ÿè®¡æ•°æ®ï¼‰
- **è¾…åŠ©å·¥å…·**ï¼šparse_time_expressionã€get_all_tagsã€get_all_moods
- **å®Œæˆå·¥å…·**ï¼šfinish_search

### 2. åˆ†å±‚æœç´¢æ³•ï¼ˆæ·±åº¦æ¨¡å¼ï¼‰
ç¬¬ä¸€å±‚ï¼šå¤§èŒƒå›´ç­›é€‰ï¼ˆæ ‡ç­¾ã€æ—¥æœŸã€å¿ƒæƒ…ï¼‰
- ä½¿ç”¨å„ç§ç­›é€‰å·¥å…·ç¼©å°èŒƒå›´
- å¯ä»¥ä½¿ç”¨ smart_find è‡ªåŠ¨å°è¯•å¤šç§ç­–ç•¥

ç¬¬äºŒå±‚ï¼šå†…å®¹ç­›é€‰ï¼ˆå…³é”®è¯æœç´¢ï¼‰
- ä¼˜å…ˆæœç´¢ originalContentï¼ˆåŸæ–‡ï¼‰
- ç»“åˆå¤šç§å…³é”®è¯ç»„åˆ

ç¬¬ä¸‰å±‚ï¼šæ·±åº¦é˜…è¯»ï¼ˆget_original_contentï¼‰
- é˜…è¯»æ—¥è®°åŸæ–‡ï¼Œè€ŒéHTMLä»£ç 
- è¯¦ç»†ç†è§£å†…å®¹å«ä¹‰

ç¬¬å››å±‚ï¼šå…³è”åˆ†æï¼ˆsmart_findã€ç»Ÿè®¡å·¥å…·ï¼‰
- æŸ¥æ‰¾ç›¸ä¼¼æ—¥è®°
- åˆ†æå¿ƒæƒ…è¶‹åŠ¿å’Œå†™ä½œä¹ æƒ¯

ç¬¬äº”å±‚ï¼šç»¼åˆåˆ†æï¼ˆfinish_searchï¼‰
- ç”Ÿæˆæ·±åº¦æŠ¥å‘Š
- æä¾›å¤šç»´åº¦æ´å¯Ÿ

### 2. å¯¹æ¯”åˆ†ææ³•
- **æ—¶é—´å¯¹æ¯”**ï¼šå¯¹æ¯”ä¸åŒæ—¶é—´æ®µçš„æ—¥è®°
- **æƒ…ç»ªå¯¹æ¯”**ï¼šåˆ†æåŒä¸€ä¸»é¢˜åœ¨ä¸åŒæƒ…ç»ªä¸‹çš„æè¿°
- **æ ‡ç­¾å¯¹æ¯”**ï¼šå¯¹æ¯”ä¸åŒæ ‡ç­¾ä¸‹çš„å†…å®¹å·®å¼‚

### 3. è¶‹åŠ¿è¯†åˆ«æ³•
- **æƒ…ç»ªè¶‹åŠ¿**ï¼šå¿ƒæƒ…éšæ—¶é—´çš„å˜åŒ–æ›²çº¿
- **ä¸»é¢˜è¶‹åŠ¿**ï¼šå…³æ³¨ç‚¹çš„è½¬ç§»å’Œæ¼”å˜
- **è¡Œä¸ºæ¨¡å¼**ï¼šé‡å¤å‡ºç°çš„è¡Œä¸ºæˆ–äº‹ä»¶

## å·¥å…·ä½¿ç”¨æŒ‡å—

### get_diary_detail ä½¿ç”¨æ—¶æœº
- å½“éœ€è¦é˜…è¯»æ—¥è®°å®Œæ•´æ­£æ–‡æ—¶
- å½“ç®€è¿°ä¸è¶³ä»¥åˆ¤æ–­ç›¸å…³æ€§æ—¶
- å½“éœ€è¦è¿›è¡Œæ·±åº¦å†…å®¹åˆ†ææ—¶
- **æ³¨æ„**ï¼šæ¯è°ƒç”¨ä¸€æ¬¡æ¶ˆè€—ä¸€è½®ï¼Œè°¨æ…ä½¿ç”¨

### å¤šè½®å¯¹è¯ç­–ç•¥ï¼ˆæ— å›ºå®šè½®æ•°é™åˆ¶ï¼‰
æ·±åº¦æ¨¡å¼æ²¡æœ‰å›ºå®šçš„è½®æ•°é™åˆ¶ï¼Œä½ å¯ä»¥æ ¹æ®éœ€è¦è¿›è¡Œä»»æ„å¤šè½®æœç´¢ï¼š

**å»ºè®®çš„æœç´¢æµç¨‹ï¼ˆå¯æ ¹æ®éœ€è¦æ‰©å±•ï¼‰ï¼š**
Round 1-2: è·å–åŸºç¡€æ•°æ®ï¼ˆæ ‡ç­¾ã€å¿ƒæƒ…åˆ—è¡¨ï¼‰
Round 3-4: å¤§èŒƒå›´ç­›é€‰ï¼ˆæ—¥æœŸã€æ ‡ç­¾ã€å¿ƒæƒ…ï¼‰
Round 5-6: å†…å®¹ç­›é€‰ï¼ˆå…³é”®è¯æœç´¢ï¼‰
Round 7-10: æ·±åº¦é˜…è¯»ï¼ˆget_original_content è·å–å¤šç¯‡æ—¥è®°åŸæ–‡ï¼‰
Round 11-15: å…³è”åˆ†æï¼ˆsmart_findã€ç»Ÿè®¡åˆ†æã€ç›¸ä¼¼æ—¥è®°æŸ¥æ‰¾ï¼‰
Round 16+: ç»§ç»­æ·±å…¥æ¢ç´¢ï¼Œç›´åˆ°è·å¾—æ»¡æ„çš„ç­”æ¡ˆ
Round N: ç”Ÿæˆæ·±åº¦æŠ¥å‘Šï¼ˆfinish_searchï¼‰

**ä½•æ—¶ç»§ç»­æœç´¢ï¼š**
- æ‰¾åˆ°çš„å†…å®¹è¿˜ä¸å¤Ÿå…¨é¢
- éœ€è¦éªŒè¯æŸäº›å‡è®¾
- å‘ç°æ–°çš„å…³è”çº¿ç´¢
- ç”¨æˆ·çš„é—®é¢˜éœ€è¦æ›´æ·±å…¥çš„åˆ†æ

**ä½•æ—¶ç»“æŸæœç´¢ï¼š**
- å·²ç»å…¨é¢å›ç­”äº†ç”¨æˆ·çš„é—®é¢˜
- è·å¾—äº†è¶³å¤Ÿçš„è¯æ®æ”¯æ’‘ç»“è®º
- ç»§ç»­æœç´¢ä¸ä¼šå¸¦æ¥æ–°çš„æœ‰ä»·å€¼ä¿¡æ¯
- è°ƒç”¨ finish_search ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š

## è¾“å‡ºè´¨é‡è¦æ±‚

### thought éƒ¨åˆ†
- å±•ç¤ºä½ çš„åˆ†ææ€è·¯
- è§£é‡Šä¸ºä»€ä¹ˆé€‰æ‹©è¿™ä¸ªå·¥å…·
- è¯´æ˜å½“å‰çš„åˆ†æè¿›å±•

### intermediate_result éƒ¨åˆ†
- found_count: å½“å‰æ‰¾åˆ°çš„æ—¥è®°æ•°é‡
- matched_tags: åŒ¹é…çš„æ ‡ç­¾
- matched_moods: åŒ¹é…çš„å¿ƒæƒ…
- time_range: æ—¶é—´èŒƒå›´
- analysis_notes: åˆ†æè¿‡ç¨‹ä¸­çš„å‘ç°å’Œç¬”è®°

### finish_search çš„ answer
- å¿…é¡»æ˜¯æœ‰æ·±åº¦çš„åˆ†æï¼Œä¸åªæ˜¯ç½—åˆ—æ—¥è®°
- å›ç­”ç”¨æˆ·çš„æ ¸å¿ƒé—®é¢˜
- æä¾›æ´å¯Ÿå’Œæ€»ç»“
- å¯ä»¥åŒ…å«æ•°æ®æ”¯æ’‘ï¼ˆå¦‚"è¿‡å»ä¸€ä¸ªæœˆï¼Œä½ è®°å½•äº†15æ¬¡'éš¾è¿‡'çš„å¿ƒæƒ…"ï¼‰

## è¾“å‡ºæ ¼å¼ï¼ˆå¿…é¡»ä¸¥æ ¼éµå®ˆï¼‰
æ¯è½®å›å¤å¿…é¡»ä¸”åªèƒ½è¿”å›ä»¥ä¸‹JSONç»“æ„ï¼Œä¸è¦æœ‰ä»»ä½•å…¶ä»–æ–‡å­—ï¼š

{
  "thought": {
    "current": "æè¿°ä½ ç°åœ¨åœ¨æƒ³ä»€ä¹ˆ",
    "reasoning": "è¯¦ç»†è§£é‡Šä½ çš„åˆ†ææ€è·¯å’Œå·¥å…·é€‰æ‹©",
    "confidence": 85
  },
  "progress": {
    "percent": 30,
    "stage": "analyzing|searching|filtering|reasoning|finishing",
    "message": "ç”¨æˆ·å¯è§çš„çŠ¶æ€æè¿°"
  },
  "tool_call": {
    "need_tool": true,
    "tool": "å·¥å…·åç§°",
    "params": {}
  },
  "intermediate_result": {
    "found_count": 0,
    "matched_tags": [],
    "matched_moods": [],
    "time_range": "",
    "analysis_notes": "åˆ†æè¿‡ç¨‹ä¸­çš„å‘ç°å’Œç¬”è®°"
  }
}

## å½“å‰ä¸Šä¸‹æ–‡
å½“å‰æ—¶é—´ï¼š{{current_time}}
å½“å‰æ—¥æœŸï¼š{{current_date}}
å¯ç”¨å·¥å…·ï¼š{{enabled_tools}}
æœ€å¤§è½®æ•°ï¼š{{max_rounds}}

ç”¨æˆ·æŸ¥è¯¢ï¼š{{query}}`

// ========================================
// å·¥å…·å®šä¹‰
// ========================================

/**
 * è·å–å·¥å…·å®šä¹‰åˆ—è¡¨ï¼ˆç”¨äºæç¤ºè¯ï¼‰
 * åŒ…å«è¯¦å°½çš„å·¥å…·è¯´æ˜ã€ç”¨æ³•ç¤ºä¾‹å’Œåä¾‹
 */
export function getToolDefinitions() {
  return {
    get_all_tags: {
      name: 'get_all_tags',
      description: 'è·å–ç”¨æˆ·æ‰€æœ‰æ—¥è®°ä¸­çš„æ ‡ç­¾åˆ—è¡¨ï¼Œç”¨äºäº†è§£ç”¨æˆ·æœ‰å“ªäº›æ ‡ç­¾å¯ç”¨',
      when_to_use: [
        'ç”¨æˆ·æŸ¥è¯¢ä¸­æåˆ°æ ‡ç­¾ï¼Œä½†ä½ ä¸çŸ¥é“ç”¨æˆ·æœ‰å“ªäº›æ ‡ç­¾æ—¶',
        'éœ€è¦äº†è§£ç”¨æˆ·çš„æ ‡ç­¾ä½“ç³»ï¼Œä»¥ä¾¿æ›´å¥½åœ°ç†è§£æŸ¥è¯¢æ„å›¾',
        'ç”¨æˆ·é—®"æˆ‘æœ‰å“ªäº›æ ‡ç­¾"æˆ–ç±»ä¼¼é—®é¢˜æ—¶'
      ],
      parameters: {},
      returns: 'æ ‡ç­¾åç§°æ•°ç»„ï¼Œå¦‚ ["å·¥ä½œ", "ç”Ÿæ´»", "æ—…è¡Œ"]',
      examples: {
        correct: [
          {
            scenario: 'ç”¨æˆ·é—®"å…³äºå·¥ä½œçš„æ—¥è®°æœ‰å“ªäº›"ï¼Œä½ æƒ³çŸ¥é“ç”¨æˆ·æœ‰å“ªäº›æ ‡ç­¾',
            tool_call: { tool: 'get_all_tags', params: {} },
            result: 'è¿”å› ["å·¥ä½œ", "é¡¹ç›®", "ä¼šè®®", "ç”Ÿæ´»", "æ—…è¡Œ"]'
          }
        ],
        incorrect: [
          {
            mistake: 'åœ¨å·²ç»çŸ¥é“æ ‡ç­¾çš„æƒ…å†µä¸‹è¿˜è°ƒç”¨æ­¤å·¥å…·',
            reason: 'æµªè´¹APIè°ƒç”¨ï¼Œé™ä½æ•ˆç‡',
            correct_approach: 'å¦‚æœå¯¹è¯å†å²ä¸­å·²æœ‰æ ‡ç­¾ä¿¡æ¯ï¼Œç›´æ¥ä½¿ç”¨å³å¯'
          }
        ]
      },
      notes: [
        'æ­¤å·¥å…·ä¸éœ€è¦å‚æ•°',
        'è¿”å›çš„æ˜¯ç”¨æˆ·æ‰€æœ‰æ—¥è®°ä¸­ä½¿ç”¨è¿‡çš„æ ‡ç­¾',
        'å»ºè®®åœ¨ç¬¬ä¸€è½®å°±è°ƒç”¨æ­¤å·¥å…·ï¼Œäº†è§£ç”¨æˆ·çš„æ ‡ç­¾ä½“ç³»'
      ]
    },

    get_all_moods: {
      name: 'get_all_moods',
      description: 'è·å–ç³»ç»Ÿé¢„å®šä¹‰çš„æ‰€æœ‰å¿ƒæƒ…ç±»å‹ï¼Œç”¨äºå¿ƒæƒ…ç­›é€‰å’Œäº†è§£å¯ç”¨å¿ƒæƒ…',
      when_to_use: [
        'ç”¨æˆ·æŸ¥è¯¢ä¸­æåˆ°å¿ƒæƒ…ï¼Œéœ€è¦äº†è§£ç³»ç»Ÿæ”¯æŒå“ªäº›å¿ƒæƒ…ç±»å‹',
        'éœ€è¦å°†ç”¨æˆ·æè¿°çš„å¿ƒæƒ…æ˜ å°„åˆ°ç³»ç»Ÿé¢„å®šä¹‰çš„å¿ƒæƒ…æ—¶',
        'ç”¨æˆ·é—®"æœ‰å“ªäº›å¿ƒæƒ…å¯é€‰"æ—¶'
      ],
      parameters: {},
      returns: 'å¿ƒæƒ…åç§°æ•°ç»„ï¼Œå¦‚ ["å¼€å¿ƒ", "å¹³é™", "éš¾è¿‡", "ç„¦è™‘"]',
      examples: {
        correct: [
          {
            scenario: 'ç”¨æˆ·é—®"æˆ‘éš¾è¿‡çš„æ—¶å€™å†™äº†ä»€ä¹ˆ"ï¼Œä½ æƒ³ç¡®è®¤"éš¾è¿‡"æ˜¯å¦æ˜¯æœ‰æ•ˆå¿ƒæƒ…',
            tool_call: { tool: 'get_all_moods', params: {} },
            result: 'è¿”å› ["å¼€å¿ƒ", "å¹³é™", "æ²‰æ€", "æ„Ÿæ©", "å…´å¥‹", "ç–²æƒ«", "éš¾è¿‡", "ç„¦è™‘", "ç”Ÿæ°”", "è¢«çˆ±", "åˆ›ä½œ", "æ€€æ—§"]'
          }
        ],
        incorrect: [
          {
            mistake: 'å‡è®¾ç”¨æˆ·æè¿°çš„å¿ƒæƒ…ä¸€å®šåœ¨åˆ—è¡¨ä¸­',
            reason: 'ç”¨æˆ·å¯èƒ½ç”¨"ä¼¤å¿ƒ"ã€"ä¸å¼€å¿ƒ"ç­‰è¿‘ä¹‰è¯ï¼Œéœ€è¦å…ˆè·å–å®Œæ•´åˆ—è¡¨è¿›è¡ŒåŒ¹é…',
            correct_approach: 'å…ˆè°ƒç”¨ get_all_moods è·å–å®Œæ•´å¿ƒæƒ…åˆ—è¡¨ï¼Œå†è¿›è¡ŒåŒ¹é…'
          }
        ]
      },
      notes: [
        'æ­¤å·¥å…·ä¸éœ€è¦å‚æ•°',
        'å¿ƒæƒ…åˆ—è¡¨æ˜¯ç³»ç»Ÿé¢„å®šä¹‰çš„ï¼Œç”¨æˆ·ä¸èƒ½è‡ªå®šä¹‰',
        'å¸¸è§å¿ƒæƒ…åŒ…æ‹¬ï¼šå¼€å¿ƒã€å¹³é™ã€æ²‰æ€ã€æ„Ÿæ©ã€å…´å¥‹ã€ç–²æƒ«ã€éš¾è¿‡ã€ç„¦è™‘ã€ç”Ÿæ°”ã€è¢«çˆ±ã€åˆ›ä½œã€æ€€æ—§'
      ]
    },

    search_by_tags: {
      name: 'search_by_tags',
      description: 'æŒ‰æ ‡ç­¾ç­›é€‰æ—¥è®°ï¼Œæ”¯æŒå¤šæ ‡ç­¾å’Œä¸¤ç§åŒ¹é…æ¨¡å¼ï¼ˆany/allï¼‰',
      when_to_use: [
        'ç”¨æˆ·æ˜ç¡®æåˆ°æ ‡ç­¾ï¼Œå¦‚"æ‰¾ä¸€ä¸‹å·¥ä½œç›¸å…³çš„æ—¥è®°"',
        'ç”¨æˆ·æåˆ°å¤šä¸ªæ ‡ç­¾ï¼Œå¦‚"å…³äºå·¥ä½œå’Œé¡¹ç›®çš„è®°å½•"',
        'éœ€è¦é€šè¿‡æ ‡ç­¾ç¼©å°æœç´¢èŒƒå›´æ—¶'
      ],
      parameters: {
        tags: {
          type: 'array',
          required: true,
          description: 'æ ‡ç­¾æ•°ç»„ï¼Œå¦‚ ["å·¥ä½œ", "é¡¹ç›®"]',
          example: '["å·¥ä½œ"] æˆ– ["å·¥ä½œ", "é¡¹ç›®"]'
        },
        match_mode: {
          type: 'string',
          required: false,
          default: 'any',
          description: 'åŒ¹é…æ¨¡å¼ï¼š"any"è¡¨ç¤ºæœ‰ä»»ä¸€æ ‡ç­¾å³å¯ï¼Œ"all"è¡¨ç¤ºå¿…é¡»åŒ…å«æ‰€æœ‰æ ‡ç­¾',
          example: '"any" æˆ– "all"'
        }
      },
      returns: 'ç¬¦åˆæ¡ä»¶çš„æ—¥è®°åˆ—è¡¨',
      examples: {
        correct: [
          {
            scenario: 'ç”¨æˆ·é—®"å…³äºå·¥ä½œçš„æ—¥è®°"',
            tool_call: { tool: 'search_by_tags', params: { tags: ['å·¥ä½œ'], match_mode: 'any' } },
            result: 'è¿”å›æ‰€æœ‰åŒ…å«"å·¥ä½œ"æ ‡ç­¾çš„æ—¥è®°'
          },
          {
            scenario: 'ç”¨æˆ·é—®"åŒæ—¶æœ‰å·¥ä½œå’Œé¡¹ç›®æ ‡ç­¾çš„æ—¥è®°"',
            tool_call: { tool: 'search_by_tags', params: { tags: ['å·¥ä½œ', 'é¡¹ç›®'], match_mode: 'all' } },
            result: 'è¿”å›åŒæ—¶åŒ…å«"å·¥ä½œ"å’Œ"é¡¹ç›®"ä¸¤ä¸ªæ ‡ç­¾çš„æ—¥è®°'
          },
          {
            scenario: 'ç”¨æˆ·é—®"å…³äºå·¥ä½œæˆ–æ—…è¡Œçš„æ—¥è®°"',
            tool_call: { tool: 'search_by_tags', params: { tags: ['å·¥ä½œ', 'æ—…è¡Œ'], match_mode: 'any' } },
            result: 'è¿”å›åŒ…å«"å·¥ä½œ"æˆ–"æ—…è¡Œ"ä»»ä¸€æ ‡ç­¾çš„æ—¥è®°'
          }
        ],
        incorrect: [
          {
            mistake: 'ä¼ å…¥å•ä¸ªå­—ç¬¦ä¸²è€Œä¸æ˜¯æ•°ç»„',
            wrong_call: { tool: 'search_by_tags', params: { tags: 'å·¥ä½œ' } },
            reason: 'tags å¿…é¡»æ˜¯æ•°ç»„ï¼Œå³ä½¿åªæœ‰ä¸€ä¸ªæ ‡ç­¾',
            correct_call: { tool: 'search_by_tags', params: { tags: ['å·¥ä½œ'] } }
          },
          {
            mistake: 'ä½¿ç”¨æœªå®šä¹‰çš„æ ‡ç­¾',
            wrong_call: { tool: 'search_by_tags', params: { tags: ['ä¸å­˜åœ¨çš„æ ‡ç­¾'] } },
            reason: 'åº”è¯¥å…ˆè°ƒç”¨ get_all_tags ç¡®è®¤ç”¨æˆ·æœ‰å“ªäº›æ ‡ç­¾',
            correct_approach: 'å…ˆè°ƒç”¨ get_all_tagsï¼Œç„¶åä½¿ç”¨è¿”å›çš„æ ‡ç­¾è¿›è¡Œæœç´¢'
          }
        ]
      },
      notes: [
        'tags å‚æ•°å¿…é¡»æ˜¯æ•°ç»„ï¼Œå³ä½¿åªæœ‰ä¸€ä¸ªæ ‡ç­¾ä¹Ÿè¦ç”¨æ•°ç»„',
        'match_mode é»˜è®¤ä¸º "any"ï¼Œå¯é€‰å€¼ä¸º "any" æˆ– "all"',
        'æ ‡ç­¾åŒ¹é…ä¸åŒºåˆ†å¤§å°å†™',
        'å¦‚æœç”¨æˆ·æåˆ°çš„æ ‡ç­¾ä¸å­˜åœ¨ï¼Œè¿”å›ç©ºæ•°ç»„'
      ]
    },

    search_by_mood: {
      name: 'search_by_mood',
      description: 'æŒ‰å¿ƒæƒ…ç­›é€‰æ—¥è®°ï¼Œæ”¯æŒå¤šå¿ƒæƒ…åŒæ—¶ç­›é€‰',
      when_to_use: [
        'ç”¨æˆ·æåˆ°å¿ƒæƒ…ï¼Œå¦‚"æˆ‘å¼€å¿ƒçš„æ—¶å€™å†™äº†ä»€ä¹ˆ"',
        'ç”¨æˆ·é—®"æœ€è¿‘éš¾è¿‡çš„æ—¥è®°æœ‰å“ªäº›"',
        'éœ€è¦æŒ‰æƒ…ç»ªçŠ¶æ€ç­›é€‰æ—¥è®°æ—¶'
      ],
      parameters: {
        moods: {
          type: 'array',
          required: true,
          description: 'å¿ƒæƒ…æ•°ç»„ï¼Œå¦‚ ["å¼€å¿ƒ", "å…´å¥‹"]',
          example: '["å¼€å¿ƒ"] æˆ– ["å¼€å¿ƒ", "å…´å¥‹"]'
        }
      },
      returns: 'ç¬¦åˆæ¡ä»¶çš„æ—¥è®°åˆ—è¡¨',
      examples: {
        correct: [
          {
            scenario: 'ç”¨æˆ·é—®"æˆ‘å¼€å¿ƒçš„æ—¶å€™å†™äº†ä»€ä¹ˆ"',
            tool_call: { tool: 'search_by_mood', params: { moods: ['å¼€å¿ƒ'] } },
            result: 'è¿”å›æ‰€æœ‰å¿ƒæƒ…ä¸º"å¼€å¿ƒ"çš„æ—¥è®°'
          },
          {
            scenario: 'ç”¨æˆ·é—®"å¼€å¿ƒæˆ–å…´å¥‹æ—¶çš„æ—¥è®°"',
            tool_call: { tool: 'search_by_mood', params: { moods: ['å¼€å¿ƒ', 'å…´å¥‹'] } },
            result: 'è¿”å›å¿ƒæƒ…ä¸º"å¼€å¿ƒ"æˆ–"å…´å¥‹"çš„æ—¥è®°'
          }
        ],
        incorrect: [
          {
            mistake: 'ä½¿ç”¨ç”¨æˆ·æè¿°è€Œéç³»ç»Ÿé¢„å®šä¹‰çš„å¿ƒæƒ…',
            wrong_call: { tool: 'search_by_mood', params: { moods: ['å¾ˆé«˜å…´'] } },
            reason: '"å¾ˆé«˜å…´"ä¸æ˜¯ç³»ç»Ÿé¢„å®šä¹‰çš„å¿ƒæƒ…ï¼Œåº”è¯¥æ˜ å°„åˆ°"å¼€å¿ƒ"',
            correct_approach: 'å…ˆè°ƒç”¨ get_all_moods è·å–æœ‰æ•ˆå¿ƒæƒ…åˆ—è¡¨ï¼Œå°†ç”¨æˆ·æè¿°æ˜ å°„åˆ°æœ€æ¥è¿‘çš„å¿ƒæƒ…'
          },
          {
            mistake: 'ä¼ å…¥å•ä¸ªå­—ç¬¦ä¸²',
            wrong_call: { tool: 'search_by_mood', params: { moods: 'å¼€å¿ƒ' } },
            reason: 'moods å¿…é¡»æ˜¯æ•°ç»„',
            correct_call: { tool: 'search_by_mood', params: { moods: ['å¼€å¿ƒ'] } }
          }
        ]
      },
      notes: [
        'moods å‚æ•°å¿…é¡»æ˜¯æ•°ç»„',
        'å¿ƒæƒ…å¿…é¡»æ˜¯ç³»ç»Ÿé¢„å®šä¹‰çš„ï¼ˆè°ƒç”¨ get_all_moods è·å–ï¼‰',
        'å¤šå¿ƒæƒ…ä¹‹é—´æ˜¯"æˆ–"å…³ç³»ï¼ˆä»»ä¸€åŒ¹é…å³å¯ï¼‰',
        'å¿ƒæƒ…åŒ¹é…ä¸åŒºåˆ†å¤§å°å†™'
      ]
    },

    search_by_date: {
      name: 'search_by_date',
      description: 'æŒ‰æ—¥æœŸèŒƒå›´ç­›é€‰æ—¥è®°ï¼Œç²¾ç¡®åŒ¹é…æ—¥è®°çš„åˆ›å»ºæ—¥æœŸã€‚å¿…é¡»åœ¨è°ƒç”¨ parse_time_expression ä¹‹åç«‹å³ä½¿ç”¨ï¼',
      when_to_use: [
        'ç”¨æˆ·æåˆ°å…·ä½“æ—¶é—´èŒƒå›´ï¼Œå¦‚"2024å¹´1æœˆçš„æ—¥è®°"',
        'è°ƒç”¨ parse_time_expression è·å–æ—¥æœŸåï¼Œç«‹å³ä½¿ç”¨è¿”å›çš„ start_date å’Œ end_date è°ƒç”¨æ­¤å·¥å…·',
        'ç”¨æˆ·é—®"æœ€è¿‘ä¸€å‘¨å†™äº†ä»€ä¹ˆ"ã€"ä¸Šä¸ªæœˆçš„å¿ƒæƒ…è®°å½•"ï¼ˆå…ˆparse_time_expressionï¼Œå†ç”¨è¿”å›çš„æ—¥æœŸè°ƒç”¨æ­¤å·¥å…·ï¼‰'
      ],
      parameters: {
        start_date: {
          type: 'string',
          format: 'YYYY-MM-DD',
          required: true,
          description: 'å¼€å§‹æ—¥æœŸï¼ŒåŒ…å«æ­¤æ—¥æœŸã€‚æ ¼å¼å¿…é¡»æ˜¯ YYYY-MM-DD',
          example: '"2024-01-01"'
        },
        end_date: {
          type: 'string',
          format: 'YYYY-MM-DD',
          required: true,
          description: 'ç»“æŸæ—¥æœŸï¼ŒåŒ…å«æ­¤æ—¥æœŸã€‚æ ¼å¼å¿…é¡»æ˜¯ YYYY-MM-DD',
          example: '"2024-01-31"'
        }
      },
      returns: 'ç¬¦åˆæ¡ä»¶çš„æ—¥è®°åˆ—è¡¨',
      examples: {
        correct: [
          {
            scenario: 'ç”¨æˆ·é—®"ä»Šå¤©å‘ç”Ÿäº†ä»€ä¹ˆ"',
            steps: [
              '1. è°ƒç”¨ parse_time_expression({expression: "ä»Šå¤©"}) â†’ è¿”å› {start_date: "2024-02-04", end_date: "2024-02-04"}',
              '2. è°ƒç”¨ search_by_date({start_date: "2024-02-04", end_date: "2024-02-04"})'
            ],
            result: 'è¿”å›2024å¹´2æœˆ4æ—¥çš„æ‰€æœ‰æ—¥è®°'
          },
          {
            scenario: 'ç”¨æˆ·é—®"ä¸Šå‘¨çš„æ—¥è®°"',
            steps: [
              '1. è°ƒç”¨ parse_time_expression({expression: "ä¸Šå‘¨"}) â†’ è¿”å› {start_date: "2024-01-28", end_date: "2024-02-03"}',
              '2. è°ƒç”¨ search_by_date({start_date: "2024-01-28", end_date: "2024-02-03"})'
            ],
            result: 'è¿”å›ä¸Šå‘¨ï¼ˆ1æœˆ28æ—¥è‡³2æœˆ3æ—¥ï¼‰çš„æ‰€æœ‰æ—¥è®°'
          }
        ],
        incorrect: [
          {
            mistake: 'ç›´æ¥ä¼ å…¥è‡ªç„¶è¯­è¨€ä½œä¸ºæ—¥æœŸ',
            wrong_call: { tool: 'search_by_date', params: { start_date: 'ä»Šå¤©', end_date: 'ä»Šå¤©' } },
            reason: 'å‚æ•°å¿…é¡»æ˜¯ YYYY-MM-DD æ ¼å¼ï¼Œä¸èƒ½ä¼ å…¥è‡ªç„¶è¯­è¨€',
            correct_approach: 'å…ˆè°ƒç”¨ parse_time_expression è§£ææ—¶é—´ï¼Œå†ä½¿ç”¨è¿”å›çš„æ—¥æœŸ'
          },
          {
            mistake: 'æ—¥æœŸæ ¼å¼é”™è¯¯',
            wrong_call: { tool: 'search_by_date', params: { start_date: '2024/01/01', end_date: '01-31-2024' } },
            reason: 'æ—¥æœŸæ ¼å¼å¿…é¡»æ˜¯ YYYY-MM-DDï¼Œä½¿ç”¨çŸ­æ¨ªçº¿åˆ†éš”',
            correct_call: { tool: 'search_by_date', params: { start_date: '2024-01-01', end_date: '2024-01-31' } }
          },
          {
            mistake: 'åªä¼ å…¥ä¸€ä¸ªæ—¥æœŸ',
            wrong_call: { tool: 'search_by_date', params: { start_date: '2024-01-01' } },
            reason: 'start_date å’Œ end_date éƒ½æ˜¯å¿…éœ€å‚æ•°',
            correct_call: { tool: 'search_by_date', params: { start_date: '2024-01-01', end_date: '2024-01-01' } }
          }
        ]
      },
      notes: [
        'æ—¥æœŸæ ¼å¼å¿…é¡»æ˜¯ YYYY-MM-DDï¼Œä¸èƒ½æ˜¯å…¶ä»–æ ¼å¼ï¼ˆå¦‚ YYYY/MM/DD æˆ– MM-DD-YYYYï¼‰',
        'start_date å’Œ end_date éƒ½æ˜¯åŒ…å«çš„ï¼ˆé—­åŒºé—´ï¼‰',
        'å¦‚æœåªéœ€è¦ä¸€å¤©ï¼Œstart_date å’Œ end_date è®¾ç½®ä¸ºç›¸åŒå€¼',
        'å¿…é¡»å…ˆè°ƒç”¨ parse_time_expression å°†è‡ªç„¶è¯­è¨€è½¬æ¢ä¸ºæ—¥æœŸæ ¼å¼',
        'æ—¥æœŸæ˜¯æ—¥è®°çš„åˆ›å»ºæ—¥æœŸï¼Œä¸æ˜¯æ—¥è®°å†…å®¹ä¸­æåˆ°çš„æ—¥æœŸ'
      ]
    },

    search_by_keyword: {
      name: 'search_by_keyword',
      description: 'æŒ‰å…³é”®è¯æœç´¢æ—¥è®°ï¼Œå¯æŒ‡å®šæœç´¢å­—æ®µï¼ˆæ ‡é¢˜ã€æ­£æ–‡ã€æ‘˜è¦ã€æ ‡ç­¾ï¼‰',
      when_to_use: [
        'ç”¨æˆ·æåˆ°å…·ä½“å…³é”®è¯ï¼Œå¦‚"æ‰¾ä¸€ä¸‹å…³äºä¼šè®®çš„è®°å½•"',
        'éœ€è¦åœ¨æ—¥è®°å†…å®¹ä¸­æœç´¢ç‰¹å®šæ–‡å­—',
        'æ ‡ç­¾æœç´¢ä¸å¤Ÿç²¾ç¡®ï¼Œéœ€è¦å…¨æ–‡æœç´¢æ—¶'
      ],
      parameters: {
        keywords: {
          type: 'array',
          required: true,
          description: 'å…³é”®è¯æ•°ç»„ï¼Œå¦‚ ["ä¼šè®®", "é¡¹ç›®"ã€‚å¤šä¸ªå…³é”®è¯ä¹‹é—´æ˜¯"æˆ–"å…³ç³»',
          example: '["ä¼šè®®"] æˆ– ["ä¼šè®®", "é¡¹ç›®"]'
        },
        search_in: {
          type: 'array',
          required: false,
          default: ['title', 'content', 'summary', 'tags'],
          description: 'æœç´¢èŒƒå›´æ•°ç»„ï¼Œå¯é€‰å€¼ï¼š"title"æ ‡é¢˜ã€"content"æ­£æ–‡ã€"summary"æ‘˜è¦ã€"tags"æ ‡ç­¾',
          example: '["title", "content"] æˆ– ["tags"]'
        }
      },
      returns: 'ç¬¦åˆæ¡ä»¶çš„æ—¥è®°åˆ—è¡¨',
      examples: {
        correct: [
          {
            scenario: 'ç”¨æˆ·é—®"æ‰¾ä¸€ä¸‹å…³äºä¼šè®®çš„æ—¥è®°"',
            tool_call: { tool: 'search_by_keyword', params: { keywords: ['ä¼šè®®'], search_in: ['title', 'content', 'summary', 'tags'] } },
            result: 'è¿”å›æ ‡é¢˜ã€æ­£æ–‡ã€æ‘˜è¦æˆ–æ ‡ç­¾ä¸­åŒ…å«"ä¼šè®®"çš„æ—¥è®°'
          },
          {
            scenario: 'ç”¨æˆ·é—®"æ ‡é¢˜ä¸­æœ‰é¡¹ç›®çš„æ—¥è®°"',
            tool_call: { tool: 'search_by_keyword', params: { keywords: ['é¡¹ç›®'], search_in: ['title'] } },
            result: 'è¿”å›æ ‡é¢˜ä¸­åŒ…å«"é¡¹ç›®"çš„æ—¥è®°'
          },
          {
            scenario: 'ç”¨æˆ·é—®"å…³äºä¼šè®®æˆ–é¡¹ç›®çš„è®°å½•"',
            tool_call: { tool: 'search_by_keyword', params: { keywords: ['ä¼šè®®', 'é¡¹ç›®'], search_in: ['title', 'content'] } },
            result: 'è¿”å›æ ‡é¢˜æˆ–æ­£æ–‡ä¸­åŒ…å«"ä¼šè®®"æˆ–"é¡¹ç›®"ä»»ä¸€å…³é”®è¯çš„æ—¥è®°'
          }
        ],
        incorrect: [
          {
            mistake: 'ä¼ å…¥å•ä¸ªå­—ç¬¦ä¸²è€Œéæ•°ç»„',
            wrong_call: { tool: 'search_by_keyword', params: { keywords: 'ä¼šè®®' } },
            reason: 'keywords å¿…é¡»æ˜¯æ•°ç»„',
            correct_call: { tool: 'search_by_keyword', params: { keywords: ['ä¼šè®®'] } }
          },
          {
            mistake: 'ä½¿ç”¨æ— æ•ˆçš„ search_in å€¼',
            wrong_call: { tool: 'search_by_keyword', params: { keywords: ['ä¼šè®®'], search_in: ['æ ‡é¢˜'] } },
            reason: 'search_in å¿…é¡»æ˜¯è‹±æ–‡å€¼ï¼štitleã€contentã€summaryã€tags',
            correct_call: { tool: 'search_by_keyword', params: { keywords: ['ä¼šè®®'], search_in: ['title'] } }
          }
        ]
      },
      notes: [
        'keywords å¿…é¡»æ˜¯æ•°ç»„ï¼Œå³ä½¿åªæœ‰ä¸€ä¸ªå…³é”®è¯',
        'å¤šä¸ªå…³é”®è¯ä¹‹é—´æ˜¯"æˆ–"å…³ç³»ï¼ˆä»»ä¸€åŒ¹é…å³å¯ï¼‰',
        'search_in é»˜è®¤ä¸º ["title", "content", "summary", "tags"]',
        'å…³é”®è¯åŒ¹é…ä¸åŒºåˆ†å¤§å°å†™',
        'search_in å¿…é¡»æ˜¯è‹±æ–‡å€¼ï¼štitleã€contentã€summaryã€tags'
      ]
    },

    get_diary_detail: {
      name: 'get_diary_detail',
      description: 'è·å–å•ç¯‡æ—¥è®°çš„å®Œæ•´å†…å®¹ï¼ŒåŒ…æ‹¬æ­£æ–‡ã€æ ‡ç­¾ã€å¿ƒæƒ…ç­‰æ‰€æœ‰å­—æ®µã€‚ä»…åœ¨æ·±åº¦æœç´¢æ¨¡å¼ä¸­ä½¿ç”¨',
      when_to_use: [
        'æ·±åº¦æœç´¢æ¨¡å¼ä¸‹ï¼Œéœ€è¦æŸ¥çœ‹æ—¥è®°å®Œæ•´å†…å®¹è¿›è¡Œåˆ†æ',
        'å¿«é€Ÿæœç´¢ç»“æœä¸å¤Ÿè¯¦ç»†ï¼Œéœ€è¦æŸ¥çœ‹æ­£æ–‡ç¡®è®¤ç›¸å…³æ€§',
        'ç”¨æˆ·é—®çš„é—®é¢˜éœ€è¦åŸºäºæ—¥è®°è¯¦ç»†å†…å®¹å›ç­”'
      ],
      parameters: {
        diary_id: {
          type: 'string',
          required: true,
          description: 'æ—¥è®°çš„å”¯ä¸€ID',
          example: '"diary_123456"'
        }
      },
      returns: 'æ—¥è®°å®Œæ•´å¯¹è±¡ï¼ŒåŒ…å«æ‰€æœ‰å­—æ®µ',
      examples: {
        correct: [
          {
            scenario: 'æ·±åº¦æœç´¢ä¸­ï¼Œæ‰¾åˆ°ä¸€ç¯‡å¯èƒ½ç›¸å…³çš„æ—¥è®°ï¼Œéœ€è¦æŸ¥çœ‹å®Œæ•´å†…å®¹ç¡®è®¤',
            tool_call: { tool: 'get_diary_detail', params: { diary_id: 'diary_123456' } },
            result: 'è¿”å›è¯¥æ—¥è®°çš„å®Œæ•´å¯¹è±¡ï¼ŒåŒ…æ‹¬æ ‡é¢˜ã€æ­£æ–‡ã€æ ‡ç­¾ã€å¿ƒæƒ…ã€åˆ›å»ºæ—¶é—´ç­‰'
          }
        ],
        incorrect: [
          {
            mistake: 'åœ¨å¿«é€Ÿæœç´¢ä¸­è°ƒç”¨æ­¤å·¥å…·',
            reason: 'å¿«é€Ÿæœç´¢æœ€å¤š3è½®ï¼Œä¸åº”è¯¥æµªè´¹è½®æ¬¡è·å–è¯¦æƒ…ã€‚å¿«é€Ÿæœç´¢åŸºäºç®€è¿°åˆ†æå³å¯',
            correct_approach: 'å¿«é€Ÿæœç´¢åªä½¿ç”¨æ—¥è®°ç®€è¿°ï¼Œæ·±åº¦æœç´¢æ‰éœ€è¦æŸ¥çœ‹å®Œæ•´å†…å®¹'
          },
          {
            mistake: 'ä¼ å…¥ä¸å­˜åœ¨çš„æ—¥è®°ID',
            wrong_call: { tool: 'get_diary_detail', params: { diary_id: 'ä¸å­˜åœ¨çš„ID' } },
            reason: 'ä¼šè¿”å› nullï¼Œæµªè´¹APIè°ƒç”¨',
            correct_approach: 'ç¡®ä¿ä¼ å…¥çš„IDæ¥è‡ªä¹‹å‰çš„æœç´¢ç»“æœ'
          }
        ]
      },
      notes: [
        'æ­¤å·¥å…·ä»…åœ¨æ·±åº¦æœç´¢æ¨¡å¼ä¸­ä½¿ç”¨',
        'ä¼šæ¶ˆè€—APIè°ƒç”¨è½®æ¬¡ï¼Œè°¨æ…ä½¿ç”¨',
        'è¿”å› null è¡¨ç¤ºæ—¥è®°ä¸å­˜åœ¨',
        'è¿”å›çš„å¯¹è±¡åŒ…å«HTMLæ ¼å¼å†…å®¹(htmlContent)ï¼Œå¦‚éœ€é˜…è¯»åŸæ–‡è¯·ä½¿ç”¨ get_original_content'
      ]
    },

    get_original_content: {
      name: 'get_original_content',
      description: 'è·å–æ—¥è®°çš„åŸå§‹æ–‡æœ¬å†…å®¹ï¼ˆç”¨æˆ·å†™ä½œæ—¶çš„åŸæ–‡ï¼‰ï¼Œä¼˜å…ˆäºhtmlContentã€‚å½“éœ€è¦é˜…è¯»æ—¥è®°æ­£æ–‡æ—¶ä½¿ç”¨æ­¤å·¥å…·',
      when_to_use: [
        'éœ€è¦é˜…è¯»æ—¥è®°çš„åŸå§‹æ–‡æœ¬å†…å®¹è€ŒéHTMLä»£ç ',
        'æ·±åº¦åˆ†ææ—¥è®°å†…å®¹æ—¶',
        'get_diary_detailè¿”å›çš„å†…å®¹åŒ…å«HTMLæ ‡ç­¾éš¾ä»¥é˜…è¯»æ—¶',
        'éœ€è¦è·å–ç”¨æˆ·å†™ä½œæ—¶çš„åŸæ–‡è¿›è¡Œå†…å®¹åˆ†æ'
      ],
      parameters: {
        diary_id: {
          type: 'string',
          required: true,
          description: 'æ—¥è®°çš„å”¯ä¸€æ ‡è¯†ç¬¦',
          example: '"abc123"'
        }
      },
      returns: {
        type: 'object',
        description: 'åŒ…å«æ—¥è®°åŸæ–‡çš„å¯¹è±¡',
        fields: {
          id: 'æ—¥è®°ID',
          title: 'æ—¥è®°æ ‡é¢˜',
          originalContent: 'ç”¨æˆ·å†™ä½œæ—¶çš„åŸæ–‡ï¼ˆçº¯æ–‡æœ¬ï¼Œä¸å«HTMLæ ‡ç­¾ï¼‰',
          htmlContent: 'HTMLæ ¼å¼çš„å†…å®¹ï¼ˆå¤‡ç”¨ï¼‰',
          summary: 'æ—¥è®°æ‘˜è¦',
          createTime: 'åˆ›å»ºæ—¶é—´'
        }
      },
      examples: [
        {
          scenario: 'è·å–æ—¥è®°åŸæ–‡è¿›è¡Œé˜…è¯»',
          call: { tool: 'get_original_content', params: { diary_id: 'abc123' } },
          result: 'è¿”å›æ—¥è®°çš„åŸæ–‡å†…å®¹ï¼Œä¾¿äºé˜…è¯»å’Œåˆ†æ'
        }
      ],
      notes: [
        'ä¼˜å…ˆè¿”å› originalContentï¼ˆåŸæ–‡ï¼‰ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è¿”å› htmlContent',
        'è¿”å›çš„åŸæ–‡æ˜¯çº¯æ–‡æœ¬æ ¼å¼ï¼Œä¸å«HTMLæ ‡ç­¾',
        'æ­¤å·¥å…·é€‚åˆç”¨äºå†…å®¹é˜…è¯»å’Œæ·±åº¦åˆ†æ'
      ]
    },

    parse_time_expression: {
      name: 'parse_time_expression',
      description: 'å°†è‡ªç„¶è¯­è¨€æ—¶é—´è¡¨è¾¾å¼è§£æä¸ºæ ‡å‡†æ—¥æœŸæ ¼å¼ï¼ˆYYYY-MM-DDï¼‰ã€‚æ³¨æ„ï¼šæ­¤å·¥å…·åªéœ€è¦è°ƒç”¨ä¸€æ¬¡ï¼è·å–æ—¥æœŸååº”ç«‹å³ä½¿ç”¨ search_by_date',
      when_to_use: [
        'ç”¨æˆ·æåˆ°ä»»ä½•æ—¶é—´ç›¸å…³è¯æ±‡ï¼Œå¦‚"ä»Šå¤©"ã€"æ˜¨å¤©"ã€"ä¸Šå‘¨"ã€"æœ€è¿‘7å¤©"ï¼ˆåªè°ƒç”¨ä¸€æ¬¡ï¼ï¼‰',
        'éœ€è¦å°†è‡ªç„¶è¯­è¨€è½¬æ¢ä¸ºæ—¥æœŸæ ¼å¼ä¾› search_by_date ä½¿ç”¨ï¼ˆè°ƒç”¨ä¸€æ¬¡åç›´æ¥ä½¿ç”¨è¿”å›çš„æ—¥æœŸï¼‰',
        'ç”¨æˆ·æåˆ°ç›¸å¯¹æ—¶é—´ï¼Œå¦‚"è¿™ä¸ªæœˆ"ã€"å»å¹´"ã€"æœ€è¿‘ä¸€å‘¨"ï¼ˆä»…é¦–æ¬¡éœ€è¦è§£æï¼‰'
      ],
      parameters: {
        expression: {
          type: 'string',
          required: true,
          description: 'è‡ªç„¶è¯­è¨€æ—¶é—´è¡¨è¾¾å¼',
          example: '"ä»Šå¤©"ã€"æ˜¨å¤©"ã€"ä¸Šå‘¨"ã€"æœ€è¿‘7å¤©"ã€"2024å¹´1æœˆ"'
        }
      },
      returns: '{ start_date, end_date, description } å¯¹è±¡',
      examples: {
        correct: [
          {
            scenario: 'ç”¨æˆ·é—®"ä»Šå¤©å‘ç”Ÿäº†ä»€ä¹ˆ"',
            tool_call: { tool: 'parse_time_expression', params: { expression: 'ä»Šå¤©' } },
            result: '{ start_date: "2024-02-04", end_date: "2024-02-04", description: "ä»Šå¤©" }'
          },
          {
            scenario: 'ç”¨æˆ·é—®"ä¸Šå‘¨çš„æ—¥è®°"',
            tool_call: { tool: 'parse_time_expression', params: { expression: 'ä¸Šå‘¨' } },
            result: '{ start_date: "2024-01-28", end_date: "2024-02-03", description: "ä¸Šå‘¨" }'
          },
          {
            scenario: 'ç”¨æˆ·é—®"æœ€è¿‘7å¤©çš„è®°å½•"',
            tool_call: { tool: 'parse_time_expression', params: { expression: 'æœ€è¿‘7å¤©' } },
            result: '{ start_date: "2024-01-29", end_date: "2024-02-04", description: "æœ€è¿‘7å¤©" }'
          }
        ],
        incorrect: [
          {
            mistake: 'ç›´æ¥ä½¿ç”¨è¿”å›ç»“æœä½œä¸ºæ—¥æœŸï¼Œè€Œä¸æå– start_date å’Œ end_date',
            reason: 'search_by_date éœ€è¦ start_date å’Œ end_date ä¸¤ä¸ªå‚æ•°',
            correct_approach: 'const result = parse_time_expression({expression: "ä»Šå¤©"}); ç„¶åä½¿ç”¨ result.start_date å’Œ result.end_date'
          },
          {
            mistake: 'ä¼ å…¥å·²ç»æ ¼å¼åŒ–çš„æ—¥æœŸ',
            wrong_call: { tool: 'parse_time_expression', params: { expression: '2024-01-01' } },
            reason: 'æ­¤å·¥å…·ç”¨äºè§£æè‡ªç„¶è¯­è¨€ï¼Œå¦‚æœå·²ç»æ˜¯æ ‡å‡†æ ¼å¼ï¼Œç›´æ¥ä½¿ç”¨å³å¯',
            correct_approach: 'å¦‚æœç”¨æˆ·ç›´æ¥è¯´äº†"2024-01-01"ï¼Œç›´æ¥ä½¿ç”¨è¿™ä¸ªæ—¥æœŸï¼Œä¸éœ€è¦è°ƒç”¨æ­¤å·¥å…·'
          }
        ]
      },
      notes: [
        'æ”¯æŒçš„æ—¶é—´è¡¨è¾¾å¼ï¼šä»Šå¤©ã€æ˜¨å¤©ã€å‰å¤©ã€æœ¬å‘¨ã€ä¸Šå‘¨ã€æœ¬æœˆã€ä¸Šæœˆã€ä»Šå¹´ã€å»å¹´ã€æœ€è¿‘Nå¤©',
        'è¿”å›çš„æ—¥æœŸæ ¼å¼æ˜¯ YYYY-MM-DD',
        'start_date å’Œ end_date éƒ½æ˜¯åŒ…å«çš„',
        'å¦‚æœè¡¨è¾¾å¼æ— æ³•è§£æï¼Œè¿”å› null',
        'å½“å‰æ—¶é—´æ˜¯åŸºäºç³»ç»Ÿæ—¶é—´è®¡ç®—çš„'
      ]
    },

    smart_find: {
      name: 'smart_find',
      description: 'æ™ºèƒ½æŸ¥æ‰¾æ—¥è®°ï¼Œè‡ªåŠ¨å°è¯•å¤šç§æœç´¢ç­–ç•¥ç›´åˆ°æ‰¾åˆ°ç»“æœã€‚å½“å¸¸è§„æœç´¢å¤±è´¥æˆ–ä¸ç¡®å®šä½¿ç”¨å“ªä¸ªå·¥å…·æ—¶ä½¿ç”¨æ­¤å·¥å…·',
      when_to_use: [
        'å¸¸è§„æœç´¢æ²¡æœ‰æ‰¾åˆ°æ—¥è®°ï¼Œä½†ç”¨æˆ·ç¡®è®¤åº”è¯¥æœ‰',
        'ä¸ç¡®å®šè¯¥ç”¨å“ªä¸ªæœç´¢å·¥å…·',
        'ç”¨æˆ·æŸ¥è¯¢æ¯”è¾ƒæ¨¡ç³Šï¼Œéœ€è¦æ™ºèƒ½åŒ¹é…',
        'å°è¯•å¤šç§æœç´¢æ–¹å¼ä»æœªæ‰¾åˆ°ç»“æœ'
      ],
      parameters: {
        query: {
          type: 'string',
          required: true,
          description: 'ç”¨æˆ·çš„è‡ªç„¶è¯­è¨€æŸ¥è¯¢',
          example: '"ä»Šå¤©å‘ç”Ÿçš„äº‹æƒ…"ã€"å…³äºå·¥ä½œçš„è®°å½•"'
        },
        strategies: {
          type: 'array',
          required: false,
          description: 'æœç´¢ç­–ç•¥æ•°ç»„ï¼Œå¯é€‰ï¼šdate(æ—¥æœŸ)ã€keyword(å…³é”®è¯)ã€tag(æ ‡ç­¾)ã€mood(å¿ƒæƒ…)ã€all(å…¨éƒ¨)',
          example: '["date", "keyword"] æˆ– ["all"]'
        }
      },
      returns: 'æœç´¢ç»“æœå¯¹è±¡ï¼ŒåŒ…å«æ‰¾åˆ°çš„æ—¥è®°å’Œä½¿ç”¨çš„ç­–ç•¥',
      examples: {
        correct: [
          {
            scenario: 'ç”¨æˆ·æœç´¢"ä»Šå¤©"ä½†æ²¡æœ‰æ‰¾åˆ°ï¼Œä½¿ç”¨smart_findè‡ªåŠ¨å°è¯•',
            tool_call: { tool: 'smart_find', params: { query: 'ä»Šå¤©', strategies: ['date', 'keyword'] } },
            result: '{ diaries: [...], strategy: "date", message: "ä½¿ç”¨æ—¥æœŸç­–ç•¥æ‰¾åˆ°3ç¯‡æ—¥è®°" }'
          }
        ]
      },
      notes: [
        'æ­¤å·¥å…·ä¼šè‡ªåŠ¨å°è¯•å¤šç§æœç´¢ç­–ç•¥',
        'å¦‚æœæ‰¾åˆ°ç»“æœï¼Œä¼šè¿”å›ä½¿ç”¨çš„ç­–ç•¥ç±»å‹',
        'å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œä¼šè¿”å›å°è¯•è¿‡çš„æ‰€æœ‰ç­–ç•¥'
      ]
    },

    get_diary_statistics: {
      name: 'get_diary_statistics',
      description: 'è·å–æ—¥è®°çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œå¦‚æ€»æ•°ã€æ—¶é—´åˆ†å¸ƒã€å¿ƒæƒ…åˆ†å¸ƒã€è¿ç»­è®°å½•å¤©æ•°ç­‰',
      when_to_use: [
        'ç”¨æˆ·é—®"æˆ‘å†™äº†å¤šå°‘ç¯‡æ—¥è®°"',
        'éœ€è¦äº†è§£æ—¥è®°çš„æ•´ä½“æƒ…å†µ',
        'è¿›è¡Œæ•°æ®åˆ†æå’Œè¶‹åŠ¿åˆ¤æ–­å‰',
        'ç”¨æˆ·æƒ³äº†è§£è‡ªå·±çš„å†™ä½œä¹ æƒ¯'
      ],
      parameters: {
        stat_type: {
          type: 'string',
          required: false,
          description: 'ç»Ÿè®¡ç±»å‹ï¼štotal(æ€»æ•°)ã€mood_distribution(å¿ƒæƒ…åˆ†å¸ƒ)ã€date_distribution(æ—¥æœŸåˆ†å¸ƒ)ã€writing_streak(è¿ç»­è®°å½•)',
          example: '"total"ã€"mood_distribution"'
        }
      },
      returns: 'ç»Ÿè®¡æ•°æ®å¯¹è±¡',
      examples: {
        correct: [
          {
            scenario: 'è·å–æ—¥è®°æ€»æ•°',
            tool_call: { tool: 'get_diary_statistics', params: { stat_type: 'total' } },
            result: '{ total: 150, first_diary_date: "2023-01-01", last_diary_date: "2024-02-04" }'
          },
          {
            scenario: 'è·å–å¿ƒæƒ…åˆ†å¸ƒ',
            tool_call: { tool: 'get_diary_statistics', params: { stat_type: 'mood_distribution' } },
            result: '{ moods: { "å¼€å¿ƒ": 50, "å¹³é™": 30, "éš¾è¿‡": 10 } }'
          }
        ]
      },
      notes: [
        'å¯ç”¨äºäº†è§£ç”¨æˆ·çš„å†™ä½œä¹ æƒ¯',
        'å¿ƒæƒ…åˆ†å¸ƒå¯ä»¥å¸®åŠ©åˆ†ææƒ…ç»ªè¶‹åŠ¿',
        'è¿ç»­è®°å½•å¤©æ•°å¯ä»¥é¼“åŠ±ç”¨æˆ·ä¿æŒä¹ æƒ¯'
      ]
    },

    finish_search: {
      name: 'finish_search',
      description: 'ç»“æŸæœç´¢ï¼Œè¿”å›æœ€ç»ˆç»“æœç»™ç”¨æˆ·ã€‚å½“ä½ è®¤ä¸ºå·²ç»æ‰¾åˆ°è¶³å¤Ÿä¿¡æ¯å›ç­”ç”¨æˆ·é—®é¢˜æ—¶ï¼Œå¿…é¡»è°ƒç”¨æ­¤å·¥å…·',
      when_to_use: [
        'å·²ç»æ‰¾åˆ°è¶³å¤Ÿä¿¡æ¯å›ç­”ç”¨æˆ·é—®é¢˜',
        'è¾¾åˆ°æœ€å¤§è½®æ•°é™åˆ¶å‰ï¼Œæå‰ç»“æŸæœç´¢',
        'ç”¨æˆ·çš„é—®é¢˜å·²ç»å¾—åˆ°å®Œæ•´å›ç­”'
      ],
      parameters: {
        found_diaries: {
          type: 'array',
          required: true,
          description: 'æ‰¾åˆ°çš„æ—¥è®°åˆ—è¡¨ï¼Œé€šå¸¸æ˜¯ç»è¿‡ç­›é€‰åçš„æ—¥è®°å¯¹è±¡æ•°ç»„',
          example: '[{id: "1", title: "...", ...}, {id: "2", title: "...", ...}]'
        },
        answer: {
          type: 'string',
          required: true,
          description: 'å¯¹ç”¨æˆ·çš„å›ç­”æˆ–æ€»ç»“ã€‚åº”è¯¥ç›´æ¥å›ç­”ç”¨æˆ·çš„é—®é¢˜ï¼Œæ€»ç»“æ‰¾åˆ°çš„æ—¥è®°å†…å®¹',
          example: '"ä»Šå¤©æ‚¨è®°å½•äº†3ç¯‡æ—¥è®°ï¼šä¸Šåˆå®Œæˆäº†é¡¹ç›®æ€»ç»“ï¼Œä¸‹åˆå’Œæœ‹å‹èšé¤ï¼Œæ™šä¸Šé˜…è¯»äº†ä¸€æœ¬ä¹¦ã€‚"'
        },
        reasoning: {
          type: 'string',
          required: false,
          description: 'æœç´¢è¿‡ç¨‹çš„æ¨ç†è¯´æ˜ï¼Œè§£é‡Šä½ æ˜¯å¦‚ä½•æ‰¾åˆ°è¿™äº›ç»“æœçš„',
          example: '"é€šè¿‡æ—¥æœŸç­›é€‰æ‰¾åˆ°ä»Šå¤©çš„æ—¥è®°ï¼Œç„¶ååˆ†æå†…å®¹ç”Ÿæˆæ€»ç»“ã€‚"'
        },
        suggestions: {
          type: 'array',
          required: false,
          description: 'ç›¸å…³æœç´¢å»ºè®®ï¼Œæä¾›ç»™ç”¨æˆ·å¯èƒ½çš„åç»­æŸ¥è¯¢',
          example: '["æŸ¥çœ‹æ˜¨å¤©çš„æ—¥è®°", "å…³äºå·¥ä½œçš„è®°å½•"]'
        }
      },
      returns: 'æœç´¢ç»“æœå¯¹è±¡ï¼ŒåŒ…å« found_diariesã€answerã€reasoningã€suggestions',
      examples: {
        correct: [
          {
            scenario: 'ç”¨æˆ·é—®"ä»Šå¤©å‘ç”Ÿäº†ä»€ä¹ˆ"ï¼Œå·²æ‰¾åˆ°3ç¯‡ä»Šå¤©çš„æ—¥è®°',
            tool_call: {
              tool: 'finish_search',
              params: {
                found_diaries: [{id: '1', title: '...'}, {id: '2', title: '...'}],
                answer: 'ä»Šå¤©æ‚¨è®°å½•äº†3ç¯‡æ—¥è®°ï¼šä¸Šåˆå®Œæˆäº†é¡¹ç›®æ€»ç»“ï¼Œä¸‹åˆå’Œæœ‹å‹èšé¤ï¼Œæ™šä¸Šé˜…è¯»äº†ä¸€æœ¬ä¹¦ã€‚',
                reasoning: 'é€šè¿‡æ—¥æœŸç­›é€‰æ‰¾åˆ°ä»Šå¤©çš„3ç¯‡æ—¥è®°ï¼Œåˆ†æå†…å®¹åç”Ÿæˆæ€»ç»“ã€‚',
                suggestions: ['æŸ¥çœ‹æ˜¨å¤©çš„æ—¥è®°', 'æœ¬å‘¨çš„è®°å½•']
              }
            },
            result: 'æœç´¢ç»“æŸï¼Œè¿”å›ç»“æœç»™ç”¨æˆ·'
          }
        ],
        incorrect: [
          {
            mistake: 'åœ¨æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æ—¥è®°æ—¶è°ƒç”¨',
            wrong_call: { tool: 'finish_search', params: { found_diaries: [], answer: '' } },
            reason: 'åº”è¯¥è¿”å›æœ‰æ„ä¹‰çš„å›ç­”ï¼Œå¦‚"æ²¡æœ‰æ‰¾åˆ°ç›¸å…³æ—¥è®°"',
            correct_approach: 'answer åº”è¯¥è¯´æ˜æ²¡æœ‰æ‰¾åˆ°ç»“æœï¼Œå¹¶ç»™å‡ºå»ºè®®'
          },
          {
            mistake: 'answer åªæ˜¯ç®€å•åˆ—å‡ºæ—¥è®°æ ‡é¢˜',
            wrong_call: { tool: 'finish_search', params: { found_diaries: ['æ—¥è®°1', 'æ—¥è®°2', 'æ—¥è®°3'], answer: 'æ‰¾åˆ°3ç¯‡æ—¥è®°ï¼šæ—¥è®°1ã€æ—¥è®°2ã€æ—¥è®°3' } },
            reason: 'answer åº”è¯¥æ˜¯æœ‰æ„ä¹‰çš„æ€»ç»“ï¼Œç›´æ¥å›ç­”ç”¨æˆ·çš„é—®é¢˜',
            correct_approach: 'åˆ†ææ—¥è®°å†…å®¹ï¼Œç»™å‡ºæœ‰æ„ä¹‰çš„å›ç­”ï¼Œå¦‚"ä»Šå¤©æ‚¨å®Œæˆäº†é¡¹ç›®æ€»ç»“å¹¶å’Œæœ‹å‹èšé¤"'
          }
        ]
      },
      notes: [
        'æ­¤å·¥å…·å¿…é¡»åœ¨æœç´¢ç»“æŸæ—¶è°ƒç”¨',
        'found_diaries ä¸èƒ½ä¸ºç©ºæ•°ç»„ï¼ˆè‡³å°‘è¿”å›ç©ºç»“æœè¯´æ˜ï¼‰',
        'answer å¿…é¡»ç›´æ¥å›ç­”ç”¨æˆ·çš„é—®é¢˜ï¼Œä¸èƒ½åªæ˜¯åˆ—å‡ºæ—¥è®°',
        'suggestions æ˜¯å¯é€‰çš„ï¼Œä½†å»ºè®®æä¾›ä»¥å¢åŠ äº¤äº’æ€§',
        'è°ƒç”¨æ­¤å·¥å…·åï¼Œæœç´¢æµç¨‹ç»“æŸ'
      ]
    }
  }
}

// ========================================
// å·¥å…·å®ç°
// ========================================

/**
 * åˆ›å»ºå·¥å…·æ‰§è¡Œå™¨
 * @param {Array} diaries - æ‰€æœ‰æ—¥è®°
 * @param {Array} allTags - æ‰€æœ‰æ ‡ç­¾
 * @returns {Object} å·¥å…·å‡½æ•°å¯¹è±¡
 */
function createTools(diaries, allTags) {
  // é¢„å®šä¹‰çš„å¿ƒæƒ…åˆ—è¡¨
  const ALL_MOODS = ['å¼€å¿ƒ', 'å¹³é™', 'æ²‰æ€', 'æ„Ÿæ©', 'å…´å¥‹', 'ç–²æƒ«', 'éš¾è¿‡', 'ç„¦è™‘', 'ç”Ÿæ°”', 'è¢«çˆ±', 'åˆ›ä½œ', 'æ€€æ—§']
  
  return {
    // è·å–æ‰€æœ‰æ ‡ç­¾
    get_all_tags: async () => {
      return [...new Set(allTags.flat())].filter(Boolean)
    },
    
    // è·å–æ‰€æœ‰å¿ƒæƒ…
    get_all_moods: async () => {
      return ALL_MOODS
    },
    
    // æŒ‰æ ‡ç­¾æœç´¢
    search_by_tags: async (params) => {
      const { tags, match_mode = 'any' } = params
      if (!tags || tags.length === 0) return diaries
      
      return diaries.filter(diary => {
        if (!diary.tags || diary.tags.length === 0) return false
        
        if (match_mode === 'all') {
          return tags.every(tag => diary.tags.some(t => t.toLowerCase() === tag.toLowerCase()))
        } else {
          return tags.some(tag => diary.tags.some(t => t.toLowerCase() === tag.toLowerCase()))
        }
      })
    },
    
    // æŒ‰å¿ƒæƒ…æœç´¢
    search_by_mood: async (params) => {
      const { moods } = params
      if (!moods || moods.length === 0) return diaries
      
      return diaries.filter(diary => {
        if (!diary.mood) return false
        return moods.some(mood => diary.mood.toLowerCase() === mood.toLowerCase())
      })
    },
    
    // æŒ‰æ—¥æœŸæœç´¢
    search_by_date: async (params) => {
      const { start_date, end_date } = params
      
      return diaries.filter(diary => {
        // ä½¿ç”¨æ›´å¯é çš„æ—¥æœŸè§£æï¼Œé¿å…æ—¶åŒºé—®é¢˜
        const diaryDateObj = new Date(diary.createTime)
        // ä½¿ç”¨æœ¬åœ°æ—¶é—´æ ¼å¼åŒ–ï¼Œé¿å…UTCè½¬æ¢å¯¼è‡´çš„æ—¥æœŸåå·®
        const diaryDate = diaryDateObj.toLocaleDateString('zh-CN', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit'
        }).replace(/\//g, '-')
        
        if (start_date && diaryDate < start_date) return false
        if (end_date && diaryDate > end_date) return false
        return true
      })
    },
    
    // æŒ‰å…³é”®è¯æœç´¢
    search_by_keyword: async (params) => {
      const { keywords, search_in = ['title', 'content', 'summary', 'tags'] } = params
      if (!keywords || keywords.length === 0) return diaries
      
      return diaries.filter(diary => {
        return keywords.some(keyword => {
          const term = keyword.toLowerCase()
          
          if (search_in.includes('title') && diary.title?.toLowerCase().includes(term)) return true
          // ä¼˜å…ˆæœç´¢åŸæ–‡(originalContent)ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™æœç´¢HTMLå†…å®¹
          if (search_in.includes('content')) {
            const contentToSearch = diary.originalContent || diary.htmlContent || ''
            if (contentToSearch.toLowerCase().includes(term)) return true
          }
          if (search_in.includes('summary') && diary.summary?.toLowerCase().includes(term)) return true
          if (search_in.includes('tags') && diary.tags?.some(t => t.toLowerCase().includes(term))) return true
          
          return false
        })
      })
    },
    
    // è·å–æ—¥è®°è¯¦æƒ…
    get_diary_detail: async (params) => {
      const { diary_id } = params
      return diaries.find(d => d.id === diary_id) || null
    },

    // è·å–æ—¥è®°åŸæ–‡
    get_original_content: async (params) => {
      const { diary_id } = params
      const diary = diaries.find(d => d.id === diary_id)
      if (!diary) return null

      // ä¼˜å…ˆè¿”å›åŸæ–‡ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è¿”å›HTMLå†…å®¹ï¼ˆå»é™¤æ ‡ç­¾ï¼‰
      let originalContent = diary.originalContent
      if (!originalContent && diary.htmlContent) {
        // ä»HTMLä¸­æå–çº¯æ–‡æœ¬
        originalContent = diary.htmlContent.replace(/<[^>]*>/g, '').replace(/&nbsp;/g, ' ').trim()
      }

      return {
        id: diary.id,
        title: diary.title,
        originalContent: originalContent || '',
        htmlContent: diary.htmlContent || '',
        summary: diary.summary || '',
        createTime: diary.createTime
      }
    },

    // è§£ææ—¶é—´è¡¨è¾¾å¼
    parse_time_expression: async (params) => {
      const { expression } = params
      return parseTimeExpression(expression)
    },
    
    // æ™ºèƒ½æŸ¥æ‰¾
    smart_find: async (params) => {
      const { query, strategies = ['all'] } = params
      const searchStrategies = strategies.includes('all') ? ['date', 'keyword', 'tag', 'mood'] : strategies

      for (const strategy of searchStrategies) {
        let result = []

        if (strategy === 'date') {
          // å°è¯•è§£ææ—¶é—´å¹¶æœç´¢
          const timeResult = parseTimeExpression(query)
          if (timeResult) {
            result = diaries.filter(diary => {
              const diaryDateObj = new Date(diary.createTime)
              const diaryDate = diaryDateObj.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
              }).replace(/\//g, '-')
              if (timeResult.start_date && diaryDate < timeResult.start_date) return false
              if (timeResult.end_date && diaryDate > timeResult.end_date) return false
              return true
            })
          }
        } else if (strategy === 'keyword') {
          // æå–å…³é”®è¯å¹¶æœç´¢
          const keywords = query.split(/\s+/).filter(w => w.length > 1)
          if (keywords.length > 0) {
            result = diaries.filter(diary => {
              return keywords.some(keyword => {
                const term = keyword.toLowerCase()
                const contentToSearch = diary.originalContent || diary.htmlContent || ''
                if (diary.title?.toLowerCase().includes(term)) return true
                if (contentToSearch.toLowerCase().includes(term)) return true
                if (diary.summary?.toLowerCase().includes(term)) return true
                if (diary.tags?.some(t => t.toLowerCase().includes(term))) return true
                return false
              })
            })
          }
        } else if (strategy === 'tag') {
          // å°è¯•ä½œä¸ºæ ‡ç­¾æœç´¢
          result = diaries.filter(diary => 
            diary.tags?.some(tag => tag.toLowerCase().includes(query.toLowerCase()))
          )
        } else if (strategy === 'mood') {
          // å°è¯•ä½œä¸ºå¿ƒæƒ…æœç´¢
          result = diaries.filter(diary => 
            diary.mood?.toLowerCase() === query.toLowerCase()
          )
        }

        if (result.length > 0) {
          return {
            diaries: result,
            strategy: strategy,
            message: `ä½¿ç”¨ ${strategy} ç­–ç•¥æ‰¾åˆ° ${result.length} ç¯‡æ—¥è®°`
          }
        }
      }

      return {
        diaries: [],
        strategy: null,
        message: 'å°è¯•æ‰€æœ‰ç­–ç•¥åä»æœªæ‰¾åˆ°æ—¥è®°',
        tried_strategies: searchStrategies
      }
    },

    // æ—¥è®°ç»Ÿè®¡
    get_diary_statistics: async (params) => {
      const { stat_type = 'total' } = params

      if (stat_type === 'total') {
        const sortedDiaries = [...diaries].sort((a, b) => new Date(a.createTime) - new Date(b.createTime))
        return {
          total: diaries.length,
          first_diary_date: sortedDiaries[0]?.createTime || null,
          last_diary_date: sortedDiaries[sortedDiaries.length - 1]?.createTime || null
        }
      }

      if (stat_type === 'mood_distribution') {
        const moodCount = {}
        diaries.forEach(diary => {
          const mood = diary.mood || 'æœªè®°å½•'
          moodCount[mood] = (moodCount[mood] || 0) + 1
        })
        return { moods: moodCount }
      }

      if (stat_type === 'writing_streak') {
        // è®¡ç®—è¿ç»­å†™ä½œå¤©æ•°
        const dateSet = new Set()
        diaries.forEach(diary => {
          const date = new Date(diary.createTime).toLocaleDateString('zh-CN')
          dateSet.add(date)
        })

        const sortedDates = Array.from(dateSet).sort()
        let currentStreak = 0
        let longestStreak = 0
        let tempStreak = 0

        for (let i = 0; i < sortedDates.length; i++) {
          if (i === 0) {
            tempStreak = 1
          } else {
            const prevDate = new Date(sortedDates[i - 1])
            const currDate = new Date(sortedDates[i])
            const diffDays = (currDate - prevDate) / (1000 * 60 * 60 * 24)

            if (diffDays === 1) {
              tempStreak++
            } else {
              longestStreak = Math.max(longestStreak, tempStreak)
              tempStreak = 1
            }
          }
        }
        longestStreak = Math.max(longestStreak, tempStreak)

        // è®¡ç®—å½“å‰è¿ç»­å¤©æ•°
        const today = new Date().toLocaleDateString('zh-CN')
        const lastDate = sortedDates[sortedDates.length - 1]
        if (lastDate === today) {
          currentStreak = tempStreak
        }

        return {
          current_streak: currentStreak,
          longest_streak: longestStreak,
          total_days: dateSet.size,
          last_write_date: lastDate
        }
      }

      return { error: 'æœªçŸ¥çš„ç»Ÿè®¡ç±»å‹' }
    },

    // ç»“æŸæœç´¢
    finish_search: async (params) => {
      return {
        type: 'finish',
        ...params
      }
    }
  }
}

/**
 * è§£ææ—¶é—´è¡¨è¾¾å¼
 * @param {string} expression - æ—¶é—´è¡¨è¾¾å¼
 * @returns {Object} { start_date, end_date, description }
 */
function parseTimeExpression(expression) {
  if (!expression) return null
  
  const expr = expression.toLowerCase().trim()
  const now = new Date()
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate())
  
  const formatDate = (date) => {
    return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`
  }
  
  // ä»Šå¤©
  if (expr === 'ä»Šå¤©' || expr === 'ä»Šæ—¥') {
    const date = formatDate(today)
    return { start_date: date, end_date: date, description: 'ä»Šå¤©' }
  }
  
  // æ˜¨å¤©
  if (expr === 'æ˜¨å¤©' || expr === 'æ˜¨æ—¥') {
    const yesterday = new Date(today)
    yesterday.setDate(yesterday.getDate() - 1)
    const date = formatDate(yesterday)
    return { start_date: date, end_date: date, description: 'æ˜¨å¤©' }
  }
  
  // å‰å¤©
  if (expr === 'å‰å¤©') {
    const dayBefore = new Date(today)
    dayBefore.setDate(dayBefore.getDate() - 2)
    const date = formatDate(dayBefore)
    return { start_date: date, end_date: date, description: 'å‰å¤©' }
  }
  
  // æœ¬å‘¨
  if (expr === 'æœ¬å‘¨' || expr === 'è¿™å‘¨' || expr === 'è¿™ä¸ªæ˜ŸæœŸ') {
    const weekStart = new Date(today)
    weekStart.setDate(weekStart.getDate() - weekStart.getDay())
    const weekEnd = new Date(weekStart)
    weekEnd.setDate(weekEnd.getDate() + 6)
    return { start_date: formatDate(weekStart), end_date: formatDate(weekEnd), description: 'æœ¬å‘¨' }
  }
  
  // ä¸Šå‘¨
  if (expr === 'ä¸Šå‘¨' || expr === 'ä¸Šæ˜ŸæœŸ') {
    const lastWeekStart = new Date(today)
    lastWeekStart.setDate(lastWeekStart.getDate() - lastWeekStart.getDay() - 7)
    const lastWeekEnd = new Date(lastWeekStart)
    lastWeekEnd.setDate(lastWeekEnd.getDate() + 6)
    return { start_date: formatDate(lastWeekStart), end_date: formatDate(lastWeekEnd), description: 'ä¸Šå‘¨' }
  }
  
  // æœ¬æœˆ
  if (expr === 'æœ¬æœˆ' || expr === 'è¿™ä¸ªæœˆ') {
    const monthStart = new Date(today.getFullYear(), today.getMonth(), 1)
    const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0)
    return { start_date: formatDate(monthStart), end_date: formatDate(monthEnd), description: 'æœ¬æœˆ' }
  }
  
  // ä¸Šä¸ªæœˆ
  if (expr === 'ä¸Šä¸ªæœˆ' || expr === 'ä¸Šæœˆ') {
    const lastMonthStart = new Date(today.getFullYear(), today.getMonth() - 1, 1)
    const lastMonthEnd = new Date(today.getFullYear(), today.getMonth(), 0)
    return { start_date: formatDate(lastMonthStart), end_date: formatDate(lastMonthEnd), description: 'ä¸Šä¸ªæœˆ' }
  }
  
  // ä»Šå¹´
  if (expr === 'ä»Šå¹´') {
    const yearStart = new Date(today.getFullYear(), 0, 1)
    const yearEnd = new Date(today.getFullYear(), 11, 31)
    return { start_date: formatDate(yearStart), end_date: formatDate(yearEnd), description: 'ä»Šå¹´' }
  }
  
  // å»å¹´
  if (expr === 'å»å¹´') {
    const lastYearStart = new Date(today.getFullYear() - 1, 0, 1)
    const lastYearEnd = new Date(today.getFullYear() - 1, 11, 31)
    return { start_date: formatDate(lastYearStart), end_date: formatDate(lastYearEnd), description: 'å»å¹´' }
  }
  
  // æœ€è¿‘Nå¤©
  const recentDaysMatch = expr.match(/^æœ€è¿‘(\d+)å¤©$/)
  if (recentDaysMatch) {
    const days = parseInt(recentDaysMatch[1])
    const start = new Date(today)
    start.setDate(start.getDate() - days + 1)
    return { start_date: formatDate(start), end_date: formatDate(today), description: `æœ€è¿‘${days}å¤©` }
  }
  
  return null
}

// ========================================
// AIè°ƒç”¨
// ========================================

/**
 * è°ƒç”¨AI
 * @param {Array} messages - å¯¹è¯æ¶ˆæ¯æ•°ç»„
 * @param {number} temperature - æ¸©åº¦
 * @returns {Promise<string>} AIå“åº”
 */
async function callAI(messages, temperature = 0.3) {
  // æ£€æŸ¥æ˜¯å¦ä½¿ç”¨ç‹¬ç«‹APIé…ç½®
  const useSeparateAPI = await getConfig('aiSearchUseSeparateAPI', false)
  
  let apiBaseUrl, apiKey, model
  
  if (useSeparateAPI) {
    // ä½¿ç”¨ç‹¬ç«‹APIé…ç½®
    apiBaseUrl = await getConfig('aiSearchApiBaseUrl', '')
    apiKey = await getConfig('aiSearchApiKey', '')
    model = await getConfig('aiSearchModel', 'gpt-4o-mini')
    
    console.log('[AI Search] ä½¿ç”¨ç‹¬ç«‹APIé…ç½®')
  } else {
    // ä½¿ç”¨ä¸»æ¨¡å‹é…ç½®
    apiBaseUrl = await getConfig('apiBaseUrl', '')
    apiKey = await getConfig('apiKey', '')
    model = await getConfig('aiModel', 'gpt-4o-mini')
    
    console.log('[AI Search] ä½¿ç”¨ä¸»æ¨¡å‹é…ç½®')
  }
  
  if (!apiBaseUrl || !apiKey) {
    throw new Error('AIæœªé…ç½®ï¼Œè¯·å…ˆè®¾ç½®APIä¿¡æ¯')
  }
  
  // è·å–æ¸©åº¦å‚æ•°ï¼ˆå¯é…ç½®ï¼‰
  const configuredTemp = await getConfig('aiSearchTemperature', temperature)
  
  // æ„å»ºè¯·æ±‚ä½“
  const requestBody = {
    model: model,
    messages: messages,
    temperature: configuredTemp
  }
  
  console.log('[AI Search] APIè¯·æ±‚:', {
    url: `${apiBaseUrl}/chat/completions`,
    model: model,
    temperature: configuredTemp,
    messagesCount: messages.length,
    useSeparateAPI: useSeparateAPI
  })
  
  const response = await fetch(`${apiBaseUrl}/chat/completions`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${apiKey}`
    },
    body: JSON.stringify(requestBody)
  })
  
  if (!response.ok) {
    const errorText = await response.text()
    console.error('[AI Search] APIé”™è¯¯å“åº”:', errorText)
    
    // å°è¯•è§£æé”™è¯¯ä¿¡æ¯
    let errorMessage = errorText
    try {
      const errorJson = JSON.parse(errorText)
      if (errorJson.error) {
        errorMessage = errorJson.error.message || errorJson.error.code || errorText
      }
    } catch (e) {
      // ä¸æ˜¯JSONæ ¼å¼ï¼Œä½¿ç”¨åŸå§‹æ–‡æœ¬
    }
    
    throw new Error(`APIè°ƒç”¨å¤±è´¥: ${response.status} - ${errorMessage}`)
  }
  
  const data = await response.json()
  return data.choices[0].message.content
}

/**
 * è§£æAIå“åº”
 * @param {string} response - AIå“åº”æ–‡æœ¬
 * @returns {Object} è§£æåçš„JSON
 */
function parseAIResponse(response) {
  try {
    // å°è¯•ç›´æ¥è§£æ
    return JSON.parse(response)
  } catch (e) {
    // å°è¯•æå–JSONä»£ç å—
    const jsonMatch = response.match(/```json\s*([\s\S]*?)\s*```/)
    if (jsonMatch) {
      return JSON.parse(jsonMatch[1])
    }
    
    // å°è¯•æå–èŠ±æ‹¬å·å†…å®¹
    const braceMatch = response.match(/\{[\s\S]*\}/)
    if (braceMatch) {
      return JSON.parse(braceMatch[0])
    }
    
    throw new Error('æ— æ³•è§£æAIå“åº”')
  }
}

// ========================================
// æœç´¢çŠ¶æ€ç®¡ç†
// ========================================

class SearchStatusManager {
  constructor(onStatusUpdate) {
    this.onStatusUpdate = onStatusUpdate
    this.round = 0
  }
  
  update(thought, progress, toolCall, intermediateResult) {
    if (this.onStatusUpdate) {
      this.onStatusUpdate({
        round: this.round,
        thought,
        progress,
        toolCall,
        intermediateResult
      })
    }
  }
  
  nextRound() {
    this.round++
  }
}

// ========================================
// å¿«é€Ÿæœç´¢
// ========================================

/**
 * å¿«é€Ÿæœç´¢
 * @param {string} query - ç”¨æˆ·æŸ¥è¯¢
 * @param {Array} diaries - æ‰€æœ‰æ—¥è®°
 * @param {Array} allTags - æ‰€æœ‰æ ‡ç­¾
 * @param {Function} onStatusUpdate - çŠ¶æ€æ›´æ–°å›è°ƒ
 * @returns {Promise<Object>} æœç´¢ç»“æœ
 */
export async function quickSearch(query, diaries, allTags = [], onStatusUpdate) {
  const status = new SearchStatusManager(onStatusUpdate)
  const tools = createTools(diaries, allTags)
  const maxRounds = 6 // å¿«é€Ÿæ¨¡å¼æœ€å¤š6è½®ï¼Œä½†AIåº”è¯¥è‡ªä¸»å†³å®šä½•æ—¶ç»“æŸ

  // ä½¿ç”¨æ ‡å‡†å¯¹è¯æ ¼å¼
  const messages = []
  let currentDiaries = [...diaries] // å½“å‰ç­›é€‰ç»“æœ

  try {
    for (let round = 0; round < maxRounds; round++) {
      status.nextRound()
      
      // æ„å»ºç³»ç»Ÿæç¤ºè¯ï¼ˆåªæ·»åŠ ä¸€æ¬¡ï¼‰
      if (round === 0) {
        const systemPrompt = await buildSystemPrompt('quick', query, tools, currentDiaries)
        messages.push({ role: 'system', content: systemPrompt })
      }
      
      // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯ï¼ˆåŒ…å«å¯¹è¯å†å²æ‘˜è¦ï¼‰
      const userPrompt = buildUserPrompt(round, query, messages, currentDiaries)
      messages.push({ role: 'user', content: userPrompt })
      
      // è°ƒç”¨AI
      const response = await callAI(messages, 0.3)
      
      // æ·»åŠ AIå“åº”åˆ°å¯¹è¯å†å²
      messages.push({ role: 'assistant', content: response })
      
      // è§£æJSON
      const parsed = parseAIResponse(response)
      
      // æ›´æ–°UIçŠ¶æ€
      status.update(
        parsed.thought,
        parsed.progress,
        parsed.tool_call,
        parsed.intermediate_result
      )
      
      // å¤„ç†å·¥å…·è°ƒç”¨ï¼ˆæ”¯æŒå•å·¥å…·å’Œå¤šå·¥å…·ï¼‰
      const toolCalls = parsed.tool_calls || (parsed.tool_call?.need_tool ? [parsed.tool_call] : [])

      if (toolCalls.length > 0) {
        const results = []
        let hasFinishSearch = false
        let finishSearchResult = null

        // å¹¶è¡Œæ‰§è¡Œæ‰€æœ‰å·¥å…·
        for (const toolCall of toolCalls) {
          const toolName = toolCall.tool
          const toolParams = toolCall.params || {}

          // æ‰§è¡Œå·¥å…·ï¼ˆä¼ å…¥å…¨éƒ¨æ—¥è®°å’Œå½“å‰ç­›é€‰ç»“æœï¼‰
          const toolResult = await executeTool(toolName, toolParams, tools, diaries, currentDiaries)

          // æ›´æ–°å½“å‰æ—¥è®°åˆ—è¡¨ï¼ˆå¦‚æœæ˜¯æœç´¢å·¥å…·ï¼‰
          if (Array.isArray(toolResult)) {
            currentDiaries = toolResult
          }

          // è®°å½•ç»“æœ
          results.push({
            tool: toolName,
            params: toolParams,
            result: toolResult
          })

          // æ£€æŸ¥æ˜¯å¦æ˜¯finish_search
          if (toolName === 'finish_search' && toolResult.type === 'finish') {
            hasFinishSearch = true
            finishSearchResult = toolResult
          }
        }

        // æ·»åŠ å·¥å…·å“åº”ä½œä¸ºç”¨æˆ·æ¶ˆæ¯ï¼ˆè®©AIçŸ¥é“å·¥å…·æ‰§è¡Œç»“æœï¼‰
        if (results.length === 1) {
          messages.push({
            role: 'user',
            content: `å·¥å…·æ‰§è¡Œç»“æœï¼š${JSON.stringify(results[0])}`
          })
        } else {
          messages.push({
            role: 'user',
            content: `å¤šå·¥å…·æ‰§è¡Œç»“æœï¼š${JSON.stringify(results)}`
          })
        }

        // å¦‚æœåŒ…å«finish_searchï¼Œè¿”å›ç»“æœ
        if (hasFinishSearch && finishSearchResult) {
          const result = {
            results: finishSearchResult.found_diaries || currentDiaries,
            answer: finishSearchResult.answer || '',
            reasoning: finishSearchResult.reasoning || '',
            suggestions: finishSearchResult.suggestions || [],
            totalRounds: round + 1
          }
          
          // ä¿å­˜å¯¹è¯å†å²
          try {
            await saveAIConversation({
              query,
              mode: 'quick',
              messages,
              result,
              totalRounds: round + 1
            })
          } catch (saveError) {
            console.error('[AI Search] ä¿å­˜å¯¹è¯å†å²å¤±è´¥:', saveError)
          }
          
          return result
        }
      } else {
        // AIæ²¡æœ‰è°ƒç”¨å·¥å…·ï¼Œç›´æ¥è¿”å›
        break
      }
    }
    
    // å¦‚æœè¾¾åˆ°æœ€å¤§è½®æ•°ä»æœªç»“æŸï¼Œè¿”å›å½“å‰ç»“æœ
    const result = {
      results: currentDiaries,
      answer: `æ‰¾åˆ° ${currentDiaries.length} ç¯‡ç›¸å…³æ—¥è®°`,
      reasoning: 'é€šè¿‡å¤šè½®å·¥å…·è°ƒç”¨ç­›é€‰',
      suggestions: [],
      totalRounds: maxRounds
    }
    
    // ä¿å­˜å¯¹è¯å†å²
    try {
      await saveAIConversation({
        query,
        mode: 'quick',
        messages,
        result,
        totalRounds: maxRounds
      })
    } catch (saveError) {
      console.error('[AI Search] ä¿å­˜å¯¹è¯å†å²å¤±è´¥:', saveError)
    }
    
    return result
    
  } catch (error) {
    console.error('[AI Search] å¿«é€Ÿæœç´¢å¤±è´¥:', error)
    throw error
  }
}

// ========================================
// æ·±åº¦æœç´¢
// ========================================

/**
 * æ·±åº¦æœç´¢
 * @param {string} query - ç”¨æˆ·æŸ¥è¯¢
 * @param {Array} diaries - æ‰€æœ‰æ—¥è®°
 * @param {Array} allTags - æ‰€æœ‰æ ‡ç­¾
 * @param {Function} onStatusUpdate - çŠ¶æ€æ›´æ–°å›è°ƒ
 * @returns {Promise<Object>} æœç´¢ç»“æœ
 */
export async function deepSearch(query, diaries, allTags = [], onStatusUpdate) {
  const status = new SearchStatusManager(onStatusUpdate)
  const tools = createTools(diaries, allTags)
  const maxRounds = 100 // æ·±åº¦æ¨¡å¼æ— è½®æ•°é™åˆ¶ï¼Œè®¾ç½®ä¸€ä¸ªè¶³å¤Ÿå¤§çš„å€¼è®©AIè‡ªä¸»å†³å®šä½•æ—¶ç»“æŸ

  // ä½¿ç”¨æ ‡å‡†å¯¹è¯æ ¼å¼
  const messages = []
  let currentDiaries = [...diaries]

  try {
    for (let round = 0; round < maxRounds; round++) {
      status.nextRound()
      
      // æ„å»ºç³»ç»Ÿæç¤ºè¯ï¼ˆåªæ·»åŠ ä¸€æ¬¡ï¼‰
      if (round === 0) {
        const systemPrompt = await buildSystemPrompt('deep', query, tools, currentDiaries)
        messages.push({ role: 'system', content: systemPrompt })
      }
      
      // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯ï¼ˆåŒ…å«å¯¹è¯å†å²æ‘˜è¦ï¼‰
      const userPrompt = buildUserPrompt(round, query, messages, currentDiaries)
      messages.push({ role: 'user', content: userPrompt })
      
      // è°ƒç”¨AI
      const response = await callAI(messages, 0.3)
      
      // æ·»åŠ AIå“åº”åˆ°å¯¹è¯å†å²
      messages.push({ role: 'assistant', content: response })
      
      // è§£æJSON
      const parsed = parseAIResponse(response)
      
      // æ›´æ–°UIçŠ¶æ€
      status.update(
        parsed.thought,
        parsed.progress,
        parsed.tool_call,
        parsed.intermediate_result
      )
      
      // å¤„ç†å·¥å…·è°ƒç”¨ï¼ˆæ”¯æŒå•å·¥å…·å’Œå¤šå·¥å…·ï¼‰
      const toolCalls = parsed.tool_calls || (parsed.tool_call?.need_tool ? [parsed.tool_call] : [])

      if (toolCalls.length > 0) {
        const results = []
        let hasFinishSearch = false
        let finishSearchResult = null

        // å¹¶è¡Œæ‰§è¡Œæ‰€æœ‰å·¥å…·
        for (const toolCall of toolCalls) {
          const toolName = toolCall.tool
          const toolParams = toolCall.params || {}

          // æ‰§è¡Œå·¥å…·ï¼ˆä¼ å…¥å…¨éƒ¨æ—¥è®°å’Œå½“å‰ç­›é€‰ç»“æœï¼‰
          const toolResult = await executeTool(toolName, toolParams, tools, diaries, currentDiaries)

          // æ›´æ–°å½“å‰æ—¥è®°åˆ—è¡¨
          if (Array.isArray(toolResult)) {
            currentDiaries = toolResult
          }

          // è®°å½•ç»“æœ
          results.push({
            tool: toolName,
            params: toolParams,
            result: toolResult
          })

          // æ£€æŸ¥æ˜¯å¦æ˜¯finish_search
          if (toolName === 'finish_search' && toolResult.type === 'finish') {
            hasFinishSearch = true
            finishSearchResult = toolResult
          }
        }

        // æ·»åŠ å·¥å…·å“åº”ä½œä¸ºç”¨æˆ·æ¶ˆæ¯ï¼ˆè®©AIçŸ¥é“å·¥å…·æ‰§è¡Œç»“æœï¼‰
        if (results.length === 1) {
          messages.push({
            role: 'user',
            content: `å·¥å…·æ‰§è¡Œç»“æœï¼š${JSON.stringify(results[0])}`
          })
        } else {
          messages.push({
            role: 'user',
            content: `å¤šå·¥å…·æ‰§è¡Œç»“æœï¼š${JSON.stringify(results)}`
          })
        }

        // å¦‚æœåŒ…å«finish_searchï¼Œè¿”å›ç»“æœ
        if (hasFinishSearch && finishSearchResult) {
          const result = {
            results: finishSearchResult.found_diaries || currentDiaries,
            answer: finishSearchResult.answer || '',
            reasoning: finishSearchResult.reasoning || '',
            suggestions: finishSearchResult.suggestions || [],
            totalRounds: round + 1
          }
          
          // ä¿å­˜å¯¹è¯å†å²
          try {
            await saveAIConversation({
              query,
              mode: 'deep',
              messages,
              result,
              totalRounds: round + 1
            })
          } catch (saveError) {
            console.error('[AI Search] ä¿å­˜å¯¹è¯å†å²å¤±è´¥:', saveError)
          }
          
          return result
        }
      } else {
        // AIæ²¡æœ‰è°ƒç”¨å·¥å…·ï¼Œç›´æ¥è¿”å›
        break
      }
    }

    const result = {
      results: currentDiaries,
      answer: `æ·±åº¦æœç´¢å®Œæˆï¼Œæ‰¾åˆ° ${currentDiaries.length} ç¯‡ç›¸å…³æ—¥è®°`,
      reasoning: 'é€šè¿‡æ·±åº¦å¤šè½®åˆ†æ',
      suggestions: [],
      totalRounds: maxRounds
    }
    
    // ä¿å­˜å¯¹è¯å†å²
    try {
      await saveAIConversation({
        query,
        mode: 'deep',
        messages,
        result,
        totalRounds: maxRounds
      })
    } catch (saveError) {
      console.error('[AI Search] ä¿å­˜å¯¹è¯å†å²å¤±è´¥:', saveError)
    }
    
    return result
    
  } catch (error) {
    console.error('[AI Search] æ·±åº¦æœç´¢å¤±è´¥:', error)
    throw error
  }
}

// ========================================
// è¾…åŠ©å‡½æ•°
// ========================================

/**
 * æ„å»ºç³»ç»Ÿæç¤ºè¯
 * @param {string} mode - 'quick' | 'deep'
 * @param {string} query - ç”¨æˆ·æŸ¥è¯¢
 * @param {Object} tools - å·¥å…·å¯¹è±¡
 * @param {Array} currentDiaries - å½“å‰æ—¥è®°åˆ—è¡¨
 * @returns {Promise<string>} ç³»ç»Ÿæç¤ºè¯
 */
async function buildSystemPrompt(mode, query, tools, currentDiaries) {
  const now = new Date()
  const currentTime = now.toLocaleString('zh-CN')
  const currentDate = now.toLocaleDateString('zh-CN')
  
  // è·å–å·¥å…·å®šä¹‰
  const toolDefs = getToolDefinitions()
  
  // è·å–è‡ªå®šä¹‰å·¥å…·è¯´æ˜
  const customToolDescriptions = await getConfig('aiSearchCustomToolDescriptions', {})
  
  // åº”ç”¨è‡ªå®šä¹‰è¯´æ˜åˆ°å·¥å…·å®šä¹‰
  const customizedToolDefs = applyCustomToolDescriptions(toolDefs, customToolDescriptions)
  
  // è·å–å¯é…ç½®å‚æ•°
  const maxRounds = await getConfig(
    mode === 'quick' ? 'quickSearchMaxRounds' : 'deepSearchMaxRounds',
    mode === 'quick' ? 3 : 6
  )
  
  // è·å–å¯ç”¨çš„å·¥å…·åˆ—è¡¨
  const enabledToolsConfig = await getConfig('aiSearchEnabledTools', {})
  const enabledToolsList = Object.entries(enabledToolsConfig)
    .filter(([_, enabled]) => enabled)
    .map(([name, _]) => name)
  
  // å¦‚æœæ²¡æœ‰é…ç½®ï¼Œé»˜è®¤å¯ç”¨æ‰€æœ‰å·¥å…·
  const enabledTools = enabledToolsList.length > 0 
    ? enabledToolsList.join(', ')
    : 'æ‰€æœ‰å·¥å…·'
  
  // è·å–æç¤ºè¯æ¨¡æ¿
  let promptTemplate
  if (mode === 'quick') {
    promptTemplate = await getConfig('quickSearchPrompt', DEFAULT_QUICK_SEARCH_PROMPT)
  } else {
    promptTemplate = await getConfig('deepSearchPrompt', DEFAULT_DEEP_SEARCH_PROMPT)
  }
  
  // æ›¿æ¢å˜é‡
  return promptTemplate
    .replace('{{tools}}', JSON.stringify(customizedToolDefs, null, 2))
    .replace('{{current_time}}', currentTime)
    .replace('{{current_date}}', currentDate)
    .replace('{{query}}', query)
    .replace('{{current_count}}', String(currentDiaries.length))
    .replace('{{max_rounds}}', String(maxRounds))
    .replace('{{enabled_tools}}', enabledTools)
}

/**
 * åº”ç”¨è‡ªå®šä¹‰å·¥å…·è¯´æ˜åˆ°å·¥å…·å®šä¹‰
 * @param {Object} toolDefs - åŸå§‹å·¥å…·å®šä¹‰
 * @param {Object} customDescriptions - è‡ªå®šä¹‰å·¥å…·è¯´æ˜
 * @returns {Object} è‡ªå®šä¹‰åçš„å·¥å…·å®šä¹‰
 */
function applyCustomToolDescriptions(toolDefs, customDescriptions) {
  if (!customDescriptions || Object.keys(customDescriptions).length === 0) {
    return toolDefs
  }
  
  const customized = {}
  
  for (const [key, toolDef] of Object.entries(toolDefs)) {
    customized[key] = { ...toolDef }
    
    // å¦‚æœæœ‰è‡ªå®šä¹‰è¯´æ˜ï¼Œåº”ç”¨åˆ° when_to_use
    if (customDescriptions[key] && customDescriptions[key].trim()) {
      customized[key].when_to_use = [customDescriptions[key].trim()]
    }
  }
  
  return customized
}

/**
 * æ„å»ºç”¨æˆ·æç¤ºè¯
 * @param {number} round - å½“å‰è½®æ¬¡
 * @param {string} query - ç”¨æˆ·æŸ¥è¯¢
 * @param {Array} messages - å¯¹è¯å†å²
 * @param {Array} currentDiaries - å½“å‰æ—¥è®°åˆ—è¡¨
 * @returns {string} ç”¨æˆ·æç¤ºè¯
 */
function buildUserPrompt(round, query, messages, currentDiaries) {
  if (round === 0) {
    return `ç”¨æˆ·æŸ¥è¯¢ï¼š${query}\n\nè¿™æ˜¯ç¬¬1è½®ï¼Œè¯·æ ¹æ®ç”¨æˆ·æŸ¥è¯¢å†³å®šè°ƒç”¨å“ªä¸ªå·¥å…·ã€‚è®°ä½ï¼šå¦‚æœæ¶‰åŠæ—¶é—´ï¼Œå…ˆè°ƒç”¨ parse_time_expressionï¼Œç„¶åä½¿ç”¨è¿”å›çš„æ—¥æœŸè°ƒç”¨ search_by_dateã€‚`
  }
  
  // æ„å»ºå¯¹è¯å†å²æ‘˜è¦
  let historySummary = ''
  let hasParsedTime = false
  let hasSearchedByDate = false
  let parsedDate = null
  
  for (let i = 0; i < messages.length; i++) {
    const msg = messages[i]
    if (msg.role === 'assistant') {
      try {
        const parsed = JSON.parse(msg.content)
        if (parsed.tool_call?.tool === 'parse_time_expression') {
          hasParsedTime = true
        }
        if (parsed.tool_call?.tool === 'search_by_date') {
          hasSearchedByDate = true
        }
      } catch (e) {}
    } else if (msg.role === 'user' && msg.content.startsWith('å·¥å…·æ‰§è¡Œç»“æœï¼š')) {
      try {
        const result = JSON.parse(msg.content.replace('å·¥å…·æ‰§è¡Œç»“æœï¼š', ''))
        if (result.tool === 'parse_time_expression' && result.result) {
          parsedDate = result.result
        }
      } catch (e) {}
    }
  }
  
  // æ ¹æ®å†å²å†³å®šæç¤º
  let guidance = ''
  if (hasParsedTime && !hasSearchedByDate && parsedDate) {
    guidance = `ä½ å·²ç»è°ƒç”¨äº† parse_time_expression è·å–äº†æ—¥æœŸï¼š${JSON.stringify(parsedDate)}ã€‚ç°åœ¨ä½ åº”è¯¥ä½¿ç”¨è¿™äº›æ—¥æœŸè°ƒç”¨ search_by_dateï¼Œä¸è¦å†è°ƒç”¨ parse_time_expressionï¼`
  } else if (hasSearchedByDate) {
    guidance = `ä½ å·²ç»å®Œæˆäº†æ—¥æœŸæœç´¢ï¼Œæ‰¾åˆ° ${currentDiaries.length} ç¯‡æ—¥è®°ã€‚ç°åœ¨åº”è¯¥è°ƒç”¨ finish_search å®Œæˆæœç´¢ã€‚`
  }
  
  return `ç¬¬${round + 1}è½®\n\nå¯¹è¯å†å²æ‘˜è¦ï¼š\n- å·²è§£ææ—¶é—´ï¼š${hasParsedTime ? 'æ˜¯' : 'å¦'}\n- å·²æœç´¢æ—¥æœŸï¼š${hasSearchedByDate ? 'æ˜¯' : 'å¦'}\n- å½“å‰æ—¥è®°æ•°ï¼š${currentDiaries.length}\n\n${guidance}\n\nè¯·å†³å®šä¸‹ä¸€æ­¥æ“ä½œï¼Œè¿”å›JSONæ ¼å¼ã€‚`
}

/**
 * æ‰§è¡Œå·¥å…·
 * @param {string} toolName - å·¥å…·åç§°
 * @param {Object} params - å·¥å…·å‚æ•°
 * @param {Object} tools - å·¥å…·å¯¹è±¡
 * @param {Array} allDiaries - æ‰€æœ‰æ—¥è®°ï¼ˆåŸå§‹æ•°æ®ï¼‰
 * @param {Array} currentDiaries - å½“å‰ç­›é€‰ç»“æœï¼ˆç”¨äºæ˜¾ç¤ºæ•°é‡ï¼‰
 * @returns {Promise<any>} å·¥å…·æ‰§è¡Œç»“æœ
 */
async function executeTool(toolName, params, tools, allDiaries, currentDiaries) {
  if (!tools[toolName]) {
    throw new Error(`æœªçŸ¥å·¥å…·: ${toolName}`)
  }
  
  // å¯¹äºæœç´¢å·¥å…·ï¼Œå§‹ç»ˆåœ¨å…¨éƒ¨æ—¥è®°ä¸­æœç´¢ï¼ˆé¿å…èŒƒå›´é€å±‚ç¼©å°ï¼‰
  if (['search_by_tags', 'search_by_mood', 'search_by_date', 'search_by_keyword'].includes(toolName)) {
    // åˆ›å»ºå·¥å…·ï¼Œåœ¨å…¨éƒ¨æ—¥è®°ä¸­æœç´¢
    const allTools = createTools(allDiaries, [])
    return await allTools[toolName](params)
  }
  
  // å…¶ä»–å·¥å…·æ­£å¸¸æ‰§è¡Œ
  return await tools[toolName](params)
}

// ========================================
// å¯¼å‡º
// ========================================

export {
  SearchStatusManager,
  createTools,
  parseTimeExpression,
  buildSystemPrompt,
  buildUserPrompt,
  executeTool
}
