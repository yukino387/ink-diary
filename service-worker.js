/**
 * ¨©?? - Service Worker
 * ???PWA??????????
 * 
 * ????????????
 * - ????????Cache First??????????????????????´„
 * - API????Network First???????????????????????????—¥
 * - ?????????Cache First????????—¥
 */

const CACHE_NAME = 'ink-diary-v3'
const STATIC_ASSETS = [
  '/',
  '/index.html',
  '/manifest.json',
  '/src/main.js',
  '/src/App.vue'
]

// ?????????????????????
self.addEventListener('install', (event) => {
  console.log('[Service Worker] ?????...')
  
  event.waitUntil(
    caches.open(CACHE_NAME)
      .then((cache) => {
        console.log('[Service Worker] ??????????')
        return cache.addAll(STATIC_ASSETS)
      })
      .then(() => {
        console.log('[Service Worker] ?????????????????')
        return self.skipWaiting()
      })
      .catch((error) => {
        console.error('[Service Worker] ????????:', error)
      })
  )
})

// ???????????????·Ú????
self.addEventListener('activate', (event) => {
  console.log('[Service Worker] ??????...')
  
  event.waitUntil(
    caches.keys()
      .then((cacheNames) => {
        return Promise.all(
          cacheNames
            .filter((name) => name !== CACHE_NAME)
            .map((name) => {
              console.log('[Service Worker] ????????:', name)
              return caches.delete(name)
            })
        )
      })
      .then(() => {
        console.log('[Service Worker] ????????????')
        return self.clients.claim()
      })
  )
})

// ?????????????????????????????
self.addEventListener('fetch', (event) => {
  const { request } = event
  const url = new URL(request.url)
  
  // ??????GET?????chrome???????
  if (request.method !== 'GET' || url.protocol === 'chrome-extension:') {
    return
  }
  
  // ????1????????? - Cache First????????—¥
  if (url.hostname.includes('fonts.googleapis.com') || 
      url.hostname.includes('fonts.gstatic.com')) {
    event.respondWith(cacheFirst(request, 'google-fonts-cache'))
    return
  }
  
  // ????2??????????JS/CSS/????- Cache First
  if (request.destination === 'script' || 
      request.destination === 'style' || 
      request.destination === 'image' ||
      request.destination === 'font') {
    event.respondWith(cacheFirst(request, CACHE_NAME))
    return
  }
  
  // ????3??HTML??? - Network First???????????¡ã·Ú??
  if (request.mode === 'navigate' || request.destination === 'document') {
    event.respondWith(networkFirst(request, CACHE_NAME))
    return
  }
  
  // ???????Stale While Revalidate
  event.respondWith(staleWhileRevalidate(request, CACHE_NAME))
})

/**
 * Cache First ????
 * ????????????¦Ä?????????????ôÒ??????
 */
async function cacheFirst(request, cacheName) {
  const cache = await caches.open(cacheName)
  const cachedResponse = await cache.match(request)
  
  if (cachedResponse) {
    return cachedResponse
  }
  
  try {
    const networkResponse = await fetch(request)
    if (networkResponse.ok) {
      cache.put(request, networkResponse.clone())
    }
    return networkResponse
  } catch (error) {
    console.error('[Service Worker] ???????????:', error)
    // ??????????????????
    return new Response('?????? - ??????????', {
      status: 503,
      statusText: 'Service Unavailable',
      headers: { 'Content-Type': 'text/plain;charset=UTF-8' }
    })
  }
}

/**
 * Network First ????
 * ??????????????????????????
 */
async function networkFirst(request, cacheName) {
  const cache = await caches.open(cacheName)
  
  try {
    const networkResponse = await fetch(request)
    if (networkResponse.ok) {
      cache.put(request, networkResponse.clone())
    }
    return networkResponse
  } catch (error) {
    console.log('[Service Worker] ???????????????:', request.url)
    const cachedResponse = await cache.match(request)
    if (cachedResponse) {
      return cachedResponse
    }
    // ?????????????
    return new Response(`
      <!DOCTYPE html>
      <html lang="zh-CN">
      <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>¨©?? - ??????</title>
        <style>
          body {
            font-family: "LXGW WenKai", "Microsoft YaHei", sans-serif;
            background: #fefcf5;
            color: #2c3e50;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            text-align: center;
          }
          h1 { font-size: 2rem; margin-bottom: 1rem; }
          p { font-size: 1.1rem; color: #666; }
          .icon { font-size: 4rem; margin-bottom: 1rem; }
        </style>
      </head>
      <body>
        <div class="icon">?</div>
        <h1>?????????????</h1>
        <p>?????????????????</p>
        <p>¨©????????????????????????</p>
      </body>
      </html>
    `, {
      status: 200,
      headers: { 'Content-Type': 'text/html;charset=UTF-8' }
    })
  }
}

/**
 * Stale While Revalidate ????
 * ??????????—¤???§µ????????????????
 */
async function staleWhileRevalidate(request, cacheName) {
  const cache = await caches.open(cacheName)
  const cachedResponse = await cache.match(request)
  
  const fetchPromise = fetch(request)
    .then((networkResponse) => {
      if (networkResponse.ok) {
        cache.put(request, networkResponse.clone())
      }
      return networkResponse
    })
    .catch((error) => {
      console.log('[Service Worker] ??????????:', error)
    })
  
  // ????§Ý??—¨???????????????????????
  return cachedResponse || fetchPromise
}

// ??????????????????????????
self.addEventListener('message', (event) => {
  if (event.data === 'skipWaiting') {
    self.skipWaiting()
  }
  
  if (event.data.type === 'CACHE_NEW_DIARY') {
    // ????????????????????????
    console.log('[Service Worker] ??????????')
  }
})

// ????????????????????????????????????
self.addEventListener('sync', (event) => {
  if (event.tag === 'sync-diaries') {
    console.log('[Service Worker] ?????????')
    // ?????????????????????
  }
})

console.log('[Service Worker] ??????????')
